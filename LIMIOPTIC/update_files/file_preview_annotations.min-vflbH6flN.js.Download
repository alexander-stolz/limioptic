(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};define(["external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/store","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store"],function(n,e,o,i,a,r,s,c,l,h,u){var v,d,p,A,assert,C,y;return assert=i.assert,d=a.Annotation,A=l.KeyCode,p=u.FileViewerStore,v=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],y=function(t){return t=t.replace(/(\-\w)/g,function(t){return t[1].toUpperCase()}),t.slice(0,1).toUpperCase()+t.slice(1)},C=e.ALLOW_ANNOTATION_GHOST,(function(){function e(n){this.prevState=n.prevState,this.state=n.state,this.interfaceController=n.interfaceController,this.actionCreators=n.actionCreators,this.onResetFileFeedbackUi=t(this.onResetFileFeedbackUi,this),this.onMouseUp=t(this.onMouseUp,this),this.onOnKeydown=t(this.onOnKeydown,this),this.onScroll=t(this.onScroll,this),this.onScaleChange=t(this.onScaleChange,this),this.onAnnotationUiLeave=t(this.onAnnotationUiLeave,this),this.onAnnotationUiEnter=t(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=t(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=t(this.onAnnotationEndDrag,this),this.onAnnotationStartDrag=t(this.onAnnotationStartDrag,this),this.onAnnotationPlaced=t(this.onAnnotationPlaced,this),this.onAnnotationHidden=t(this.onAnnotationHidden,this),this.onStateChange=t(this.onStateChange,this)}return e.create=function(t){return new e({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null,actionCreators:t})},e.prototype.setState=function(t){return n.extend(this.state,t),this.performUpdateIfNecessary()},e.prototype.getStateFromStores=function(){var t,e,o,i,a;return a=r.state.showResolvedComments,e=!1,t=c.shouldShowExistingAnnotations()?r.state.activity.comment_activities.filter(function(t){var n;return(!t.comment.resolved||!e)&&null!=(null!=(n=t.comment.comment_metadata)?n.annotation:void 0)}):{},{activityKey:null!=(o=r.state.activity)?o.activity_key:void 0,actorId:r.state.actorId,activityContext:r.state.viewing.context,revision:r.state.viewing.revision,commentActivityByKey:n.indexBy(t,"activity_key"),ephemeralAnnotation:null!=(i=r.state.createAnnotation)?i.annotation:void 0,canAnnotate:c.canAnnotate(),regionCreationEnabled:c.isRegionCreationEnabled(),showResolved:a,viewingAnnotationConversation:null!=r.state.viewAnnotation}},e.prototype.onStateChange=function(){if(null!=r.state.activity)return this.setState(this.getStateFromStores())},e.prototype.mount=function(t){return assert(null!=t,"Interface controller must not be null"),assert(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(r.state),this.unsubscribeStore=r.listen(this.onStateChange),this.unsubscribeFileViewerStore=p.instance.addListener(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},e.prototype.unmount=function(){return assert(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},e.prototype.isMounted=function(){return null!=this.interfaceController},e.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},e.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},e.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},e.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},e.prototype.addAnnotationEventListeners=function(){return v.forEach((function(t){return function(n){var e,o;if(o="on"+y(n),e=t[o],null!=e)return t.interfaceController.on(n,e)}})(this))},e.prototype.removeAnnotationEventListeners=function(){return v.forEach((function(t){return function(n){var e,o;if(o="on"+y(n),e=t[o],null!=e)return t.interfaceController.off(n,e)}})(this))},e.prototype.onAnnotationHidden=function(t){return this.actionCreators.stopAnnotationCreation()},e.prototype.onAnnotationPlaced=function(t){var n;return n=d.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),h.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},e.prototype.onAnnotationStartDrag=function(t){return this.actionCreators.hideAnnotationConversation(),this.actionCreators.hideAnnotationInput()},e.prototype.onAnnotationEndDrag=function(t){var n;return this.actionCreators.hideAnnotationConversation(),n=d.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),h.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},e.prototype.onAnnotationUiClick=function(t){var n,e;return n=t.commentActivity.activity_key,this.actionCreators.revealAnnotationInPreview(n),this.actionCreators.revealCommentInPane({activityKey:n,expandConversation:!1}),h.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(e=t.commentActivity)?e.activity_key:void 0,this.state.actorId,this.state.activityContext)},e.prototype.onAnnotationUiEnter=function(t){var n,e;if(null==this.state.ephemeralAnnotation&&(null==(n=r.state.viewAnnotation)||!n.replyFocused))return this.actionCreators.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:d.createAnnotationFromDict(t.annotation)}),h.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(e=t.commentActivity)?e.activity_key:void 0,this.state.actorId,this.state.activityContext)},e.prototype.onAnnotationUiLeave=function(t){var n,e;if(this.actionCreators.updateAnnotationUiHover(!1),null==this.state.ephemeralAnnotation&&(null==(e=r.state.viewAnnotation)||!e.replyFocused))return n=(function(t){return function(){var n,e;if(t.isMounted()&&!(null!=(n=r.state.viewAnnotation)?n.conversationHover:void 0)&&!(null!=(e=r.state.viewAnnotation)?e.annotationHover:void 0))return t.actionCreators.hideAnnotationConversation()}})(this),window.setTimeout(n,50)},e.prototype.onScaleChange=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},e.prototype.onScroll=function(t){var e;return this.actionCreators.hideAnnotationInput(),this.actionCreators.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),e=n.partial((function(t){return function(n){var e;return null!=(null!=n?n.annotation:void 0)?(e=d.createAnnotationFromDict(n.annotation),t.actionCreators.startAnnotationCreation({annotation:e})):t.actionCreators.showAnnotationInput()}})(this),t),this.annotationBubbleTimer=window.setTimeout(e,150)},e.prototype.onOnKeydown=function(t){if(c.normalizedKeyCode.apply(t)===A.ESC)return this.actionCreators.stopAnnotationCreation()},e.prototype.onMouseUp=function(t){if(null!=this.state.viewingAnnotationConversation)return this.actionCreators.hideAnnotationConversation()},e.prototype.onResetFileFeedbackUi=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},e.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},e.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},e.prototype._updateAnnotations=function(t){var n,e,o,i,a,r,c,l,h,u;for(o=[],e=0,a=0,l=t.length;a<l;a++)i=t[a],i.comment.hasMetadata()&&i.comment.comment_metadata.hasAnnotationData()&&(e+=1,!this.state.showResolved&&i.comment.resolved||(h=i.comment.comment_metadata,n=h.annotation,u=h.revision,r=s.isRevisionEqual(this.state.revision,u),(C||null!=u&&r)&&(c=C&&null!=u&&!r,o.push({annotation:n,commentActivity:i,options:{isGhostAnnotation:c,isAnnotationNumberingEnabled:!0,annotationNumber:e}}))));return this.interfaceController.dispatchEvent("update-annotations",{annotations:o})},e.prototype.performUpdateIfNecessary=function(){var t,e;if(this.isMounted())return n.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(t=n.difference(null!=(e=this.prevState.activityKeys)?e:[],Object.keys(this.state.commentActivityByKey)),t.forEach(this._removeAnnotation,this),this._updateAnnotations(n.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()},e})()})}).call(this);
//# sourceMappingURL=file_preview_annotations.min.js-vflR7GFEo.map