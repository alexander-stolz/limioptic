(function(){define("modules/clean/comments/collection_utils",["modules/clean/annotations/annotation","modules/clean/datetime","modules/core/i18n"],function(t,e,o){var n,s,i,r,a,l,c,u,p,d,h,m;return n=t.Annotation,s=o._,l=function(t){var o,n,i,r,a,l,c,u,p;for(r={},u=[],c=Date.now(),a=0,l=t.length;a<l;a++)o=t[a],n=new Date(o.comment.when_mses),i=c-o.comment.when_mses,p=i<12e4?s("Just now"):i<864e5?s("Today"):i<1728e5?s("Yesterday"):e.format_date(n,"MMM d, yyyy"),r[p]?r[p].push(o):(u.push(p),r[p]=[o]);return[u,r]},a=function(t){var e,o,s,i,r,a,l,c;for(s={},l=[],r=0,a=t.length;r<a;r++)o=t[r],i=o.comment.hasMetadata()&&o.comment.comment_metadata.hasAnnotationData(),i&&(e=n.createAnnotationFromDict(o.comment.comment_metadata.annotation),c=e.isImageAnnotation()?1:e.getFirstPdfPage(),s[c]?s[c].push(o):(l.push(c),s[c]=[o]));return l.sort(function(t,e){return t-e}),[l,s]},c=function(t){var e,o,n,s,i,r;for(o=[],e=[],n=i=0,r=t.length;i<r;n=++i)s=t[n],null==s.comment?(e.push(s),n+1===t.length&&o.push(e)):(e.length&&o.push(e.slice()),e=[]);return o},i=function(t,e){var o,n,s,i,r,a,l,c,u;for(null==e&&(e={}),null==e.includeAnnotations||e.includeAnnotations,i=null==e.includeDocLevel||e.includeDocLevel,r=null==e.includeNotResolved||e.includeNotResolved,a=null!=e.includeResolved&&e.includeResolved,u=null!=e.sortBy?e.sortBy:null,n=[],l=0,c=t.length;l<c;l++)o=t[l],s=o.comment.hasMetadata()&&o.comment.comment_metadata.hasAnnotationData(),!e.includeAnnotations&&s||(i||s)&&(a&&o.comment.resolved&&n.push(o),r&&!o.comment.resolved&&n.push(o));return u&&n.sort(function(t,e){return u(t,e)}),n},r=function(t){var e,o,n,s;for(s=0,o=0,n=t.length;o<n;o++)e=t[o],e.comment.resolved&&s++;return s},d=function(t,e){return t.comment.when_mses-e.comment.when_mses},h=function(t,e){var o,n;return o=null!=t.comment?t.comment.when_mses:t.when_mses,n=null!=e.comment?e.comment.when_mses:e.when_mses,n-o},m=function(t,e){var o,n;return o=null!=t.comment?t.comment.when_mses:t[0].when_mses,n=null!=e.comment?e.comment.when_mses:e[0].when_mses,n-o},p=function(t,e){var o,n;return o=t.comment.when_mses,t.comment_activities.length>0&&(o=t.comment_activities[t.comment_activities.length-1].when_mses),n=e.comment.when_mses,e.comment_activities.length>0&&(n=e.comment_activities[e.comment_activities.length-1].when_mses),n-o},u=function(t,e){var o,s,i,r,a,l;return o=n.createAnnotationFromDict(t.comment.comment_metadata.annotation),s=n.createAnnotationFromDict(e.comment.comment_metadata.annotation),i=o.getFirstCoordindates().x,a=o.getFirstCoordindates().y,r=s.getFirstCoordindates().x,l=s.getFirstCoordindates().y,l-a||r-i},{groupCommentActivitiesByTime:l,groupAnnotationActivitiesByPage:a,groupFileRevisions:c,filterCommentActivities:i,getNumResolved:r,sortByTime:d,sortByTimeOfCommentOrFileRevision:h,sortByTimeOfCommentOrFileRevisions:m,sortByReplyTime:p,sortByCoordinates:u}})}).call(this),define("modules/clean/comments/components/stickers",["require","exports","tslib","jquery","external/react","external/react-dom","external/classnames","modules/core/i18n","modules/clean/sticker_util","modules/clean/react/pure_render","modules/clean/react/file_comments/live_sticker"],function(t,e,o,n,s,i,r,a,l,c,u){"use strict";var p=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.onClick=function(t){t.preventDefault(),e.props.onClick&&e.props.onClick(e.props.value.id)},e}return o.__extends(e,t),e.prototype.render=function(){var t=this.props.value,e=t.id,o=t.live_sticker,n=o?s.createElement(u.LiveSticker,{size:"small",skipInitial:!0,stickerId:e}):s.createElement("img",{src:l.getStickerImageUrl(e)});return s.createElement("button",{onClick:this.onClick,"data-sticker-id":e},n)},e})(s.Component);p=o.__decorate([c.pureRender],p);var d=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this,e=this.props,o=e.isSelected,n=e.data,i=r("sticker-set",{"is-selected":o});return s.createElement("div",{className:i},n.stickers.map(function(e){return s.createElement(p,{value:e,onClick:t.props.onStickerClick})}))},e})(s.Component);d=o.__decorate([c.pureRender],d);var h=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.onClick=function(t){e.props.onChangeSelection&&e.props.onChangeSelection(e.props.data.id)},e}return o.__extends(e,t),e.prototype.render=function(){var t=this.props,e=t.isSelected,o=t.data,n=r({"sticker-nav-item":!0,"is-selected":e});return s.createElement("button",{className:n,onClick:this.onClick,"aria-pressed":e},s.createElement("img",{src:l.getStickerSetImageUrl(o.id),alt:a._("Sticker set")}))},e})(s.Component);h=o.__decorate([c.pureRender],h);var m=_=(function(t){function e(e){var o=t.call(this,e)||this;o.onChangeSelection=function(t){o.setState({selected:t})},o.onStickerSelected=function(t){o.props.onStickerSelected&&o.props.onStickerSelected(t)},o.onLeftArrowPress=function(t){o.setState({scrollOffset:Math.min(0,o.state.scrollOffset+_.SCROLL_DISTANCE)})},o.onRightArrowPress=function(t){o.setState({scrollOffset:Math.max(o.getMaxScroll(),o.state.scrollOffset-_.SCROLL_DISTANCE)})};var n=l.getStickers();return o.state={stickerSets:n,selected:n[0].id,scrollOffset:0,maxScroll:-1},o}return o.__extends(e,t),e.prototype.componentWillUpdate=function(){var t=this.getMaxScroll();t!==this.state.maxScroll&&this.setState({maxScroll:t})},e.prototype.getMaxScroll=function(){var t=0;n(i.findDOMNode(this)).find(".sticker-nav-item").each(function(e){t+=n(this).outerWidth(!0)});return n(i.findDOMNode(this.refs.tabs)).width()-t-60},e.prototype.renderTabs=function(t){var e=this.props.isPopupAbove,o=this.state,n=o.scrollOffset,i=o.maxScroll,l=r({"sticker-nav":!0,"show-left":n<0,"show-right":n!==i,"on-top":e,"on-bottom":!e});return s.createElement("div",{className:l,ref:"tabs"},s.createElement("button",{"aria-label":a._("Scroll sticker set left"),className:"arrow left",onClick:this.onLeftArrowPress}),s.createElement("div",{className:"sticker-nav-inner",style:{marginLeft:n}},t),s.createElement("button",{"aria-label":a._("Scroll sticker set right"),className:"arrow right",onClick:this.onRightArrowPress}))},e.prototype.render=function(){for(var t=this.props.isPopupAbove,e=[],o=[],n=0,i=l.getStickers();n<i.length;n++){var r=i[n];e.push(s.createElement(h,{data:r,isSelected:r.id===this.state.selected,onChangeSelection:this.onChangeSelection})),o.push(s.createElement(d,{data:r,isSelected:r.id===this.state.selected,onStickerClick:this.onStickerSelected}))}return s.createElement("div",{className:"sticker-container"},s.createElement("div",{className:"sticker-menu"},t&&this.renderTabs(e),s.createElement("div",{className:"sticker-sets-scrollable"},o),!t&&this.renderTabs(e)))},e})(s.Component);m.SCROLL_DISTANCE=200,m=_=o.__decorate([c.pureRender],m),e.Stickers=m;var _}),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/contacts/bloodhound_contacts",["jquery","external/bloodhound","external/underscore","modules/clean/ajax","modules/clean/contacts/cache_store","modules/clean/contacts/contact","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/clean/viewer","modules/constants/contacts","modules/constants/request","modules/core/cookies","modules/core/exception","modules/core/uri"],function(e,o,n,s,i,r,a,l,c,u,p,d,h,m){var _,f,g,assert;return f=i.DefaultContactsCacheStore,_=r.ContactCommon,g=l.LinkedProfileServices,assert=h.assert,(function(){function e(e,n,s){var i,r,a,l,u;for(this.contacts_filter=null!=e?e:null,this.for_user=null!=n?n:null,this.limit=null!=s?s:10,this._get=t(this._get,this),this.contacts=new o({datumTokenizer:function(t){return[t.name,t.email,t.fname,t.lname].concat(t.name_tokens)},queryTokenizer:function(t){return t.query},identify:_.get_key,sufficient:this.limit,sorter:this._contacts_sorter,local:[],remote:null}),this.contacts.initialize(),this.sortedContacts=[],this.extraContacts=[],this._batchGetQueue=[],this._getRequest=null,this._updatedCallbacks=[],this.contacts_cache=f.getOrCreateForViewer(),c.get_viewer().is_signed_in&&this.contacts_cache.load_contacts(!0,(function(t){return function(e){return t._init_contacts(e)}})(this)),l=c.get_viewer().get_users(),i=0,r=l.length;i<r;i++)u=l[i],a=g.get_linked_profile_services_for_user(u.id),a.register_for_service_changes("bloodhound_contacts",(function(t){return function(e){return t.contacts.clearRemoteCache()}})(this))}return e.prototype._contacts_sorter=function(t,e){return t.sort_key>e.sort_key?-1:t.sort_key<e.sort_key?1:0},e.prototype._init_contacts=function(t){return this._update_contacts(t),this.contacts_cache.register_for_updates("bloodhound_contacts",(function(t){return function(e){return t._update_contacts(e)}})(this))},e.prototype._filter_contacts=function(t){var e;return e=null!=this.for_user&&c.get_viewer().is_user_signed_in(this.for_user)?t.includeForUser(this.for_user.id):t.excludePairedUserDuplicates(),this.contacts_filter&&(e=e.filterContacts(this.contacts_filter)),e.contacts},e.prototype._update_contacts=function(t){var e,o,n,s,i,r,a,l;for(this.contacts.clearRemoteCache(),this.contacts.clear(),n=this._filter_contacts(t).filter(_.is_valid),this.contacts.add(n),r=this._dedupe_extra_contacts().filter(_.is_valid),this.contacts.add(r),o=n.concat(r),o.sort((function(t){return function(e,o){return t._contacts_sorter(e,o)}})(this)),this.sortedContacts=o.slice(0,this.limit),a=this._updatedCallbacks,l=[],s=0,i=a.length;s<i;s++)e=a[s],l.push("function"==typeof e?e():void 0);return l},e.prototype.setExtraContacts=function(t){return this.extraContacts=t},e.prototype._dedupe_extra_contacts=function(){var t,e,o,n,s,i;for(e=this.contacts.all(),n={},o={},s=0,i=e.length;s<i;s++)t=e[s],n[t.email]=!0,o[t.dbx_account_id]=!0;return this.extraContacts.filter(function(t){return!o[t.dbx_account_id]&&!n[t.email]})},e.prototype._add_request=function(t,e){var o,n,s;return s=Boolean(0===this._batchGetQueue.length&&null===this._getRequest),n=Array.isArray(t),o={query:n?t:t.trim().split(/\s+/),callback:e,match_any:n,blocking:!0},o.match_any?this._batchGetQueue.push(o):this._getRequest=o,s},e.prototype._next_get_request=function(){var t;return t=null,null!=this._getRequest?(t=this._getRequest,this._getRequest=null):this._batchGetQueue.length>0&&(t=this._batchGetQueue[0],this._batchGetQueue.splice(0,1)),t},e.prototype._get=function(){var t,e,o,s,i,r,l,c;if(e=this._next_get_request()){if(t=(function(t){return function(o){var n;return n=a.create_contacts_list(o),"function"==typeof e.callback&&e.callback(t._filter_contacts(n)),t._get()}})(this),e.match_any){for(r=[],i=function(t){return r.push.apply(r,t)},c=e.query,o=0,s=c.length;o<s;o++)l=c[o],this.contacts.search({query:[l]},i,i);return t(r)}return this.contacts.search(n.omit(e,"callback"),t,t)}},e.prototype.get=function(t,e){if(assert(Array.isArray(t)||n.isString(t)),this._add_request(t,e))return this.contacts_cache.is_loaded()?this._get():this.contacts_cache.load_contacts(!0,this._get)},e.prototype.registerForUpdates=function(t){return this._updatedCallbacks.push(t)},e})()})}.call(this),function(){define("modules/clean/react/activity/annotation_button",["external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/image_preview_util","modules/core/i18n"],function(t,e,o,n,s,i,r){var a,l,c,u,p,d,h,m,_,f,g,y;return s.Annotation,p=s.AnnotationTypes,s.AnnotationSubtypes,g=r._,y=t.DOM,h=610,d=790,m=28,f=6,_=3,a=120,u=t.createClass({displayName:"AnnotationThumbnail",propTypes:{annotation:t.PropTypes.object,thumbnailUrl:t.PropTypes.string},getDefaultProps:function(){return{}},getInitialState:function(){return{}},_getThumbnail:function(t,e,o){var n;return this.props.thumbnailUrl?this._getThumbnailImageFromUrl():(n=m*e/o,y.div({className:"annotation-thumbnail-page",style:{width:n,height:m}},this._getAnnotationThumbnail(t,e,o,n,m)))},_getAnnotationThumbnail:function(t,o,n,s,i){var r,a,l,c,u,d,h,m,g,v,C,b,T,S,w,N,E,P;switch(r=this.props.annotation,r.type){case p.MARKER:return l=null!=t&&null!=(S=t[0].coordinates)?S[0]:void 0,y.div({className:"annotation-thumbnail-page__marker",style:{left:this._calculateThumbnailDistance(null!=l?l.x:void 0,o,s,f),top:this._calculateThumbnailDistance(null!=l?l.y:void 0,n,i,f)}});case p.HIGHLIGHT:for(N=[],T=r.getFirstPdfPage(),u=0,h=t.length;u<h;u++)c=t[u],c.page===T&&(a=c.coordinates[1].x-c.coordinates[0].x,N.push(y.div({className:"annotation-thumbnail-page__highlight",style:{left:this._calculateThumbnailDistance(c.coordinates[0].x,o,s),top:this._calculateThumbnailDistance(c.coordinates[0].y,n,i,_),width:this._calculateThumbnailDistance(a,o,s)}})));return N;case p.REGION:for(N=[],T=r.getFirstPdfPage(),d=0,m=t.length;d<m;d++)w=t[d],w.page===T&&(E=e.pluck(w.coordinates,"x"),P=e.pluck(w.coordinates,"y"),C=e.min(E),g=e.max(E),b=e.min(P),v=e.max(P),N.push(y.div({className:"annotation-thumbnail-page__region",style:{left:this._calculateThumbnailDistance(C,o,s),top:this._calculateThumbnailDistance(b,n,i),width:this._calculateThumbnailDistance(g-C,o,s),height:Math.abs(this._calculateThumbnailDistance(v,n,i)-this._calculateThumbnailDistance(b,n,i))}})));return N}},_getThumbnailImageFromUrl:function(){return y.div({className:"annotation-thumbnail-image"},y.img({src:this.props.thumbnailUrl}))},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_calculateThumbnailDistance:function(t,e,o,n){var s;return null==n&&(n=0),o-=n,s=n/2,t/e*o+s},_translateCoordinates:function(t,e,o){var n,s,i,r,a,l,c,u,p,d,h;for(p=[],i=0,a=t.length;i<a;i++){for(n=t[i],s=[],u=n.coordinates,r=0,l=u.length;r<l;r++)c=u[r],d=e(c.x),h=o(c.y),s.push({x:d,y:h});p.push({coordinates:s,page:n.page})}return p},render:function(){var t,e,o,n,s,r;return e=this.props.annotation,e.isImageAnnotation()?(t=i.getPreviewImage(),s=t.width(),n=t.height(),o=this._translateCoordinates(e.image_coordinates,function(t){return t*s},function(t){return t*n})):(s=h,n=d,null!=(null!=(r=e.pdf_coordinates)?r[0].page_size:void 0)&&(s=e.pdf_coordinates[0].page_size.width,n=e.pdf_coordinates[0].page_size.height),o=this._translateCoordinates(e.pdf_coordinates,function(t){return t},function(t){return n-t})),this._getThumbnail(o,s,n)}}),c=t.createFactory(u),l=t.createClass({displayName:"AnnotationButton",propTypes:{annotation:t.PropTypes.object,revision:t.PropTypes.object,isOldRevision:t.PropTypes.bool,onAnnotationButtonMouseUp:t.PropTypes.func,thumbnailUrl:t.PropTypes.string},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_getPageText:function(){return this.props.annotation.isPdfAnnotation()?g("Page %(page_number)s").format({page_number:this.props.annotation.getFirstPdfPage()}):this.props.annotation.isImageAnnotation()?g("Annotation"):void 0},_getLabelSubtext:function(){var t,e,o;return null!=this.props.revision.when&&!isNaN(new Date(null!=this.props.revision.when))&&this.props.isOldRevision?(o=n.ago(new Date(1e3*this.props.revision.when)),e=g("on older revision, updated %(time_ago)s").format({time_ago:o})):e=g("on latest revision"),t=this._getPageText(),g("%(page_text)s %(revision_text)s").format({page_text:t,revision_text:e})},onAnnotationButtonMouseUp:function(t){return this.props.onAnnotationButtonMouseUp(t)},render:function(){return y.a({className:"comment-annotation-button",onMouseUp:this.onAnnotationButtonMouseUp},y.div({className:"annotation-page-label"},c({annotation:this.props.annotation,thumbnailUrl:this.props.thumbnailUrl}),y.div({className:"annotation-thumbnail-label"},y.div({className:"annotation-thumbnail-label__page"},g("Go to comment")),y.div({className:"annotation-thumbnail-label__info"},this._getLabelSubtext()))),this.props.annotation.type===p.HIGHLIGHT?y.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)}}),{AnnotationButtonClass:l,AnnotationThumbnailClass:u}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_activity_ui",["external/classnames","external/react","external/react-dom","external/underscore","modules/clean/annotations/annotation","modules/clean/datetime","modules/clean/react/activity/resolve_button","modules/clean/react/activity/time_counter","modules/clean/react/modal","modules/clean/viewer","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/viewer_avatar","modules/clean/sticker_util","modules/clean/comments/constants","modules/clean/comments/comment_dom","modules/clean/comments/lib/animation","modules/clean/comments/logging","modules/clean/comments/revisions","modules/clean/event_handler","modules/clean/file_activity/models/file_activity","modules/clean/react/file_comments/live_sticker","modules/clean/react/file_comments/threaded_comment_header","modules/clean/react/title_bubble","modules/clean/react/tooltip","modules/constants/comments_panel","modules/constants/file_viewer","modules/core/exception","modules/core/i18n"],function(e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,g,y,v,C,b,T,S,w,N,E,P,I,A){var x,k,M,D,O,R,L,U,B,H,F,V,q,z,assert,K,j;return k=i.Annotation,i.AnnotationTypes,i.AnnotationSubtypes,j=r.nice_date_with_month_name,H=c.SimpleModal,R=_.FileActivityLogEventType,x=g.ANIMATION_END_EVENT,D=C.EventHandlerMixin,O=b.FileActivity,L=T.LiveSticker,N.Tooltip,N.TooltipPosition,assert=I.assert,z=A._,K=o.DOM,U=o.addons.PureRenderMixin,B=o.createFactory(a),V=o.createFactory(l),M=o.createFactory(p),q=o.createFactory(h),F=o.createFactory(S),o.createClass({displayName:"CommentActivityUI",mixins:[U,D],propTypes:{parentActivity:o.PropTypes.object.isRequired,fileActivity:o.PropTypes.instanceOf(O).isRequired,comment_activity:o.PropTypes.object.isRequired,user:o.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:o.PropTypes.bool,shouldAutoLinkify:o.PropTypes.bool,shouldUseSimpleModals:o.PropTypes.bool,shouldHidePhotoAvatars:o.PropTypes.bool,isReply:o.PropTypes.bool,shouldShowReplyButton:o.PropTypes.bool,onReplyButtonMouseUp:o.PropTypes.func,isOffline:o.PropTypes.bool,isExpanded:o.PropTypes.bool,truncateLength:o.PropTypes.number,annotationNumber:o.PropTypes.number,scrollIntoView:o.PropTypes.func,isInAnnotationBubble:o.PropTypes.bool,actionCreators:o.PropTypes.object.isRequired,isDemoMode:o.PropTypes.bool},getInitialState:function(){return{showAnnotationThumbnail:!1}},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,isExpanded:!1,isDemoMode:!1}},componentDidMount:function(){var t;return t=n.findDOMNode(this),this.events.on(t,x,this.onAnimationEnd,this)},reveal:function(){var t;if(!P.MAESTRO_ENABLED)return"function"==typeof(t=this.props).scrollIntoView&&t.scrollIntoView({node:n.findDOMNode(this),padTop:20}),this.setState({highlighting:!0})},onAnimationEnd:function(){return this.setState({highlighting:!1})},onHeaderClick:function(t){var e;return e=this.props.comment_activity,this.props.shouldAnnotationButtonUseThumbnailUrls?this.setState({showAnnotationThumbnail:!this.state.showAnnotationThumbnail}):this.props.actionCreators.revealAnnotationInPreview(e.activity_key),y.logAnnotationEvent(R.CLIENT_ANNOTATION_BUTTON_CLICKED,e.activity_key)},isPendingComment:function(){return this.props.comment_activity.is_pending},isFailedPendingComment:function(){return this.isPendingComment()&&"FAILED"===this.props.comment_activity.status},onUpdateResolve:function(t){return this.props.actionCreators.setCommentResolved({commentActivityKey:this.props.comment_activity.activity_key,resolved:t})},onDeleteComment:function(t){var e;return e=this.props.shouldUseSimpleModals?"simple":"default",t.preventDefault(),H.show({title_text:z("Delete comment?"),body_html:z("Are you sure you want to delete this comment?"),cancel_text:z("Cancel"),confirm_text:z("Delete"),style:e,confirm_callback:(function(t){return function(){return t.props.actionCreators.deleteComment({commentActivityKey:t.props.comment_activity.activity_key})}})(this)})},_isCommentForOldRevision:function(){var t,e;return e=null!=(t=this.props.comment_activity.comment.comment_metadata)?t.revision:void 0,null!=e&&!v.isRevisionEqual(e,this.props.fileActivity.latest_revision)},_shouldShowResolveButton:function(){return!this.isPendingComment()&&this.props.user.is_signed_in&&!this.props.isReply&&!P.MAESTRO_ENABLED},onReplyButtonMouseUp:function(){var t;return"function"==typeof(t=this.props).onReplyButtonMouseUp?t.onReplyButtonMouseUp():void 0},onRetryPendingComment:function(){return assert(this.isPendingComment(),"Cannot retry posting non-pending comment"),this.props.actionCreators.retryPostingComment({targetActivityKey:this.props.parentActivity.activity_key,pendingCommentActivity:this.props.comment_activity})},_renderAnnotationHeader:function(){var t,e,o,n;if(e=this.props.comment_activity.comment,e.hasMetadata()&&e.comment_metadata.hasAnnotationData())return o=e.comment_metadata,t=k.createAnnotationFromDict(o.annotation),n=o.revision,F({revision:n,annotation:t,isOldRevision:this._isCommentForOldRevision(),onClick:this.onHeaderClick,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline,shouldShowResolveButton:this._shouldShowResolveButton(),resolved:e.resolved,annotationNumber:this.props.annotationNumber,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,showAnnotationThumbnail:this.state.showAnnotationThumbnail})},renderPhoto:function(){var e,n,s;return n={dimension:32,defaultAvatar:o.createElement(d,{dimension:32,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials,name:this.props.comment_activity.comment.commenter.display_name})},this.props.shouldHidePhotoAvatars||""===this.props.comment_activity.comment.commenter.photo_circle_url||(n.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),s=this.props.comment_activity.comment.commenter.id,e=t.call(u.get_viewer().get_user_ids(!0),s)>=0?new q(n):new M(n),K.div({className:"commenter-photo"},e)},renderCommentBody:function(){var t;return t=this.props.comment_activity.comment.raw_comment_text,f.convertRawCommentTextToReactDom(t,this.props.shouldAutoLinkify,!this.props.isExpanded&&this.props.truncateLength)},renderDelete:function(t){return K.div({className:"delete-icon",onMouseDown:(function(t){return function(e){return t.onDeleteComment(e)}})(this)},z("Delete"))},renderBody:function(){var t,n,i,r,a,l,c,p,d,h;return h=u.get_viewer(),d=s.intersection(h.get_user_ids(!0),null!=(l=this.props.comment_activity.permissions)?l.user_ids_who_can_delete:void 0).length,t=(d||h.can_moderate_comments||this.props.isDemoMode)&&!this.props.isOffline&&!this.isPendingComment(),a=E.IS_COMBINED_COMMENTS_ENABLED,n=this.props.comment_activity.comment,r=n.hasMetadata()&&n.comment_metadata.hasAnnotationData(),p=this._shouldShowResolveButton()&&(!r||this.props.isInAnnotationBubble),i=e({"comment-body":!0,"has-annotation":r}),K.div({className:i},K.div({className:"comment-top-bar"},K.div({className:"commenter-name"},n.commenter.display_name),a?K.div({className:"comment-when"},o.createElement(w,{content:j(new Date(n.when_mses)),position:w.POSITIONS.TOP},V({when_mses:n.when_mses}))):void 0,P.MAESTRO_ENABLED&&t?K.div({className:"comment-delete"},K.div({className:"second-bottom-dot"}," · "),this.renderDelete()):void 0,p?B({resolved:n.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline}):void 0),n.hasMetadata()&&n.comment_metadata.hasStickerData()?(function(t){return m.isLiveSticker(t)?o.createElement(L,{stickerId:t}):K.img({className:"comment-sticker-body",src:m.getStickerImageUrl(t)})})(n.comment_metadata.getStickerId()):K.span({},K.div({className:"comment-text"},this.renderCommentBody())),this.isFailedPendingComment()?K.div({className:"comment-bottom-bar"},K.div({className:"pending-comment--failed"},K.span({className:"pending-comment__warning"},z("Unable to post comment.")),K.a({className:"pending-comment__retry",onClick:this.onRetryPendingComment},z("Retry")))):this.props.isExpanded?P.MAESTRO_ENABLED?void 0:!a||t?K.div({className:"comment-bottom-bar"},a?void 0:V({when_mses:n.when_mses}),t?K.span({className:"delete"},a?void 0:K.div({className:"second-bottom-dot"}," · "),this.renderDelete()):void 0):void 0:this.props.shouldShowReplyButton?(c=e({"reply-button":!0}),K.div({className:"comment-bottom-bar"},K.a({className:c,onMouseUp:this.onReplyButtonMouseUp},z(P.MAESTRO_ENABLED?"Reply...":"Reply")))):void 0)},render:function(){var t;return t=e({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply,"comment--pending":this.isPendingComment(),"comment--highlighting":this.state.highlighting,expanded:this.props.isExpanded}),K.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key},this._renderAnnotationHeader(),K.div({className:t},this.renderPhoto(),this.renderBody()))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_input",["jquery","external/classnames","external/react","external/react-dom","external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity_user","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/avatar/viewer_avatar","modules/clean/comments/components/stickers","modules/clean/comments/constants","modules/clean/comments/logging","modules/clean/react/title_bubble","modules/clean/contacts/types","modules/clean/contacts/util","modules/clean/file_activity/models/file_activity","modules/clean/keycode","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/mentions_controller","modules/clean/react/bubble_dropdown","modules/clean/react/button","modules/clean/react/file_comments/logger","modules/clean/react/sprite","modules/clean/storage","modules/clean/viewer"],function(e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,g,y,v,C,b,T,S,w,N,E,P,I,A,x,k){var M,D,O,R,L,U,B,H,F,V,q,z,K,j,W,G;return j=u._,u.ungettext,M=d.ActivityUser,z=f.Stickers,L=g.FileActivityLogEventType,R=g.FileActivityLogClientOriginType,O=T.FileActivity,B=S.KeyCode,H=x.LocalStorage,F=4e3,G=n.DOM,q=n.createFactory(n.addons.CSSTransitionGroup),V=n.createFactory(N),D=n.createFactory(h),U=n.createFactory(m),K=n.createFactory(_),W=n.createFactory(P.button),n.createClass({displayName:"CommentInput",mixins:[n.addons.PureRenderMixin],propTypes:{activity:n.PropTypes.instanceOf(O),usersToNotify:n.PropTypes.arrayOf(n.PropTypes.instanceOf(M)).isRequired,metadata:n.PropTypes.object,onAddComment:n.PropTypes.func,onCancelComment:n.PropTypes.func,resizeCallback:n.PropTypes.func,positionDropdownCallback:n.PropTypes.func,onFocus:n.PropTypes.func,onBlur:n.PropTypes.func,user:n.PropTypes.instanceOf(M).isRequired,onShowNewComment:n.PropTypes.func,enableNoNotifyHint:n.PropTypes.bool,showNewComment:n.PropTypes.bool,shouldPopupsDropdown:n.PropTypes.bool,initialText:n.PropTypes.string,shouldInitiallyFocusInput:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,shouldEnableStickers:n.PropTypes.bool,onAddSticker:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,enableImport:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,isReplyInput:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldEnableCancelButton:n.PropTypes.bool,isOffline:n.PropTypes.bool,shouldShowAvatar:n.PropTypes.bool,onStickerDropdownShown:n.PropTypes.func,onStickerDropdownHidden:n.PropTypes.func,onContactsSelectorPopupShown:n.PropTypes.func,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:n.PropTypes.bool,shouldDisplayRegionCreationButton:n.PropTypes.bool,onMentionedUsersChanged:n.PropTypes.func,setShouldShowNotifyHint:n.PropTypes.func,isRegionCreationEnabled:n.PropTypes.bool,onChange:n.PropTypes.func,isCommentsServerView:n.PropTypes.bool,actionCreators:n.PropTypes.object.isRequired,isCommentInputDisabled:n.PropTypes.bool,isDemoMode:n.PropTypes.bool,shouldShowPostText:n.PropTypes.bool,onEditModeChange:n.PropTypes.func},getInitialState:function(){var t,e,o,n;return e=!0,n=this.props.shouldAlwaysInEditMode,t=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=(o=this.props.activity)?o.activity_key:void 0),t.length>0&&(e=!1,n=!0),r.COMMENTS_COLLAPSE_INPUT||(n=!0),{inputIsEmpty:e,shouldShowPostButton:n,shouldShowPostText:!1,initialText:t,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:e.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1,shouldEnableCancelButton:!1,shouldShowPostText:!1,isOffline:!1,shouldShowAvatar:!0,metadata:null,shouldDisplayRegionCreationButton:!1,isDemoMode:!1,onEditModeChange:e.noop}},componentDidMount:function(){var t,o;if(t=function(t,o){var n;return n=s.findDOMNode(o)||null,!!n&&(t.target===n||e.contains(n,t.target))},e(s.findDOMNode(this)).on("click.comment-input",(function(e){return function(o){if(t(o,e.refs.postButton)&&e.verifySubscribersBeforePost(),t(o,e.refs.showNewCommentButton))return e.props.onShowNewComment()}})(this)),null!=(o=this.state.initialText)?o.length:void 0)return this.onChange()},componentWillUnmount:function(){return e(s.findDOMNode(this)).off(".comment-input")},_emailEnteredCallback:function(t){var e,o,n;return null!=(e=this.refs.mentions)&&e.addMentionIntoRangeUnicode(null!=(o=this.refs.mentions)?o.createMentionObject(t):void 0),this.setCursorToEndOfInput(),null!=(n=this.refs.mentionsHintDropdown)?n.hide():void 0},_contactHighlightedCallback:function(){var t;return null!=(t=this.refs.mentions)?t.contactHighlightedCallback():void 0},_clearContactHighlightedCallback:function(){var t;return null!=(t=this.refs.mentions)?t.clearContactHighlightedCallback():void 0},_contactsSelectorPopupShown:function(){var t,e,o;return this.setState({selectorPopupShown:!0}),null!=(e=this.refs.mentions)&&e.contactsSelectorPopupShown(this.refs.mentionsContactSelectorPopup),I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,null!=(o=this.props.activity)?o.activity_key:void 0,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id),"function"==typeof(t=this.props).onContactsSelectorPopupShown?t.onContactsSelectorPopupShown():void 0},_contactsSelectorPopupHidden:function(){var t;return this.setState({selectorPopupShown:!1}),null!=(t=this.refs.mentions)?t.contactsSelectorPopupHidden():void 0},_onContactsSelectorSuggestionsUpdate:function(){var t;return this._updateInputIsEmptyState(),"function"==typeof(t=this.props).onContactsSelectorSuggestionsUpdate?t.onContactsSelectorSuggestionsUpdate():void 0},_onAtSignKeyPress:function(){if(this.props.user.is_signed_in)return I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id)},_onNoAtSignKeyPress:function(){return I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(t){var e,o,n,s;return null!=(e=this.refs.mentions)&&e.addMentionIntoRangeUnicode(null!=(o=this.refs.mentions)?o.createMentionObjectFromSuggestion(t):void 0),null!=(n=this.refs.mentions)&&n.setCursorToEndOfInput(),null!=(s=this.refs.mentionsHintDropdown)&&s.hide(),
c.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(t){var e;return c.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),e=t?a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:a.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,I.log_event(a.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,e,this.props.user.id)},onMention:function(){var t;return this.onChange(),"function"==typeof(t=this.props).onMention?t.onMention():void 0},onChange:function(){var t,e,o,n;return n=this.refs.mentions.extractMentions(),o=n.map((function(t){return function(t){return M.fromUser({id:t.dbx_account_id||t.identifier,display_name:t.name})}})(this)),this.props.shouldShowPostText&&(this.getRawCommentInput().length>0?this.setState({shouldShowPostText:!0}):this.setState({shouldShowPostText:!1})),"function"==typeof(t=this.props).onMentionedUsersChanged&&t.onMentionedUsersChanged(o),"function"==typeof(e=this.props).onChange?e.onChange(this.getRawCommentInput()):void 0},onMentionsFocus:function(t){var e;return this.togglePostButton(!0),"function"==typeof(e=this.props).onFocus?e.onFocus(t):void 0},onMentionsBlur:function(t){var e;if("function"==typeof(e=this.props).onBlur&&e.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else this.props.shouldAlwaysInEditMode},onMentionsCancel:function(t){var e;return"function"==typeof(e=this.props).onCancelComment?e.onCancelComment():void 0},onKeyDown:function(t){return t.keyCode===B.ENTER&&(t.ctrlKey||t.metaKey)?(this.verifySubscribersBeforePost(),t.preventDefault()):this._updateInputIsEmptyState()},onKeyUp:function(t){return this._updateInputIsEmptyState(),this.onChange()},onPaste:function(t){return t.clipboardData.getData("text/plain").length>F?(p.error(j("The text you're trying to paste is too long.")),t.preventDefault()):setTimeout((function(t){return function(){return t._updateInputIsEmptyState(),t.onChange()}})(this),10)},showNoNotifyHint:function(){var t,e;return this.refreshDropdownDirection(),null!=(t=this.refs.mentionsHintDropdown)&&t.show(),null!=(e=this.refs.mentionsContactSelectorPopup)?e.showNoNotifyHint():void 0},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).positionDropdownCallback?t.positionDropdownCallback():void 0},togglePostButton:function(t){var e;return e=(function(e){return function(){var o,n;return"function"==typeof(o=e.props).resizeCallback&&o.resizeCallback(t),"function"==typeof(n=e.props).setShouldShowNotifyHint?n.setShouldShowNotifyHint(t):void 0}})(this),this.setState({shouldShowPostButton:t},e)},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(t){var e;return null!=(e=this.refs.mentionsHintDropdown)&&e.hide(),this.postComment()},_updateInputIsEmptyState:function(){var t;if(t=""===this.refs.mentions.getEncodedMessage(),this.state.inputIsEmpty!==t)return this.setState({inputIsEmpty:t})},verifySubscribersBeforePost:function(t){var e,o,n,s;return this.props.user.is_signed_in&&null!=this.props.usersToNotify&&(e=function(){var t,e,o,n;for(o=this.props.usersToNotify,n=[],t=0,e=o.length;t<e;t++)s=o[t],s.id!==this.props.user.id&&n.push(s);return n}.call(this),e&&0===e.length&&0===(null!=(o=this.props.activity)&&null!=(n=o.comment_activities)?n.length:void 0)&&this.props.enableNoNotifyHint)?void this.showNoNotifyHint():this.postComment()},_clearText:function(){return this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._updateInputIsEmptyState()},postComment:function(){var t,e;if(e=this.refs.mentions.getEncodedMessage())return e.length>F?void p.error(j("The comment is too long.")):(this.shouldSaveText()||(this._clearText(),this.setState({shouldShowPostText:!1})),"function"==typeof(t=this.props).onAddComment?t.onAddComment(e):void 0)},focusInput:function(){var t;return null!=(t=this.refs.mentions)?t.focusInput():void 0},getRawCommentInput:function(){var t;return null!=(t=this.refs.mentions)?t.getRawMessage():void 0},getPlaceholderText:function(){return j(this.props.isReplyInput?"Reply":"Write a comment")},_usersToNotifyToContacts:function(t){var e,o,n,s;for(e=[],o=0,n=t.length;o<n;o++)s=t[o],s.id!==this.props.user.id&&e.push(b.activityUserToContact(s,Number.MAX_VALUE));return e},_onCancelMouseUp:function(){var t;return"function"==typeof(t=this.props).onCancelComment?t.onCancelComment():void 0},_onRegionCreationClick:function(){var t,e;return e=!this.props.isRegionCreationEnabled,t=e?L.CLIENT_ANNOTATION_MODE_ENABLED:L.CLIENT_ANNOTATION_MODE_DISABLED,y.logEvent(t,R.ANNOTATION_MODE_BUTTON_IN_COMMENTS_PANE),this.props.actionCreators.setRegionCreationEnabled(e)},_postSticker:function(t){var e,o;return"function"==typeof(e=this.props).onAddSticker&&e.onAddSticker(t),null!=(o=this.refs.stickerDropdown)?o.hide():void 0},_clearCommentLocalStorage:function(t){return H.set("tmp-file-comment",null)},_getCommentLocalStorage:function(t){var o,n;return n=H.get("tmp-file-comment"),o="",n&&n.activity_key===t&&((new Date).getTime()-n.time<3e5&&(o=n.text),this._clearCommentLocalStorage()),e("<div/>").html(o).text()},_storeCommentLocalStorage:function(t,o){var n;return n=e("<div/>").text(t).html(),H.set("tmp-file-comment",{activity_key:o,text:n,time:(new Date).getTime()})},_renderShowNewComment:function(){var t,e;return e=[],this.props.showNewComment&&(t=G.a({className:"show-new-comment-button",ref:"showNewCommentButton"},G.span({className:"show-new-comment-icon",key:key}),G.span({className:"show-new-comment-text"},j("New Comment"))),e=G.div({className:"comment-show-new-comment"},t)),q({transitionName:"comment-show-new-comment",transitionEnterTimeout:300,transitionLeaveTimeout:300,component:"div"},e)},_renderCommentBox:function(){var t,e,n,s,i,a;return e=null!=this.props.usersToNotify?this.props.usersToNotify:[],a=this.props.user.is_signed_in&&this.state.shouldShowPostButton,i=this.props.shouldEnableStickers&&this.state.shouldShowPostButton,n=V({ref:"mentions",placeholder_text:this.getPlaceholderText(),initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,showPlaceholderText:this.state.inputIsEmpty,showMentionsHelper:a,enableNoAtMentions:r.ALLOW_NO_AT_MENTIONS&&this.props.user.is_signed_in,isDemoMode:this.props.isDemoMode,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:this.onMention,onEditModeChange:this.props.onEditModeChange,contactsSelectorPopupShown:this._contactsSelectorPopupShown,onContactsSelectorSuggestionsUpdate:this._onContactsSelectorSuggestionsUpdate,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactSelectedCallback:this._contactSelectedCallback,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(e),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),t=o({"comment-box":!0,"input-collapsed":!this.state.shouldShowPostButton}),s=o({"post-area":!0,"post-area--post-text-shown":this.state.shouldShowPostText}),G.div({className:t},this._renderCommenterPhoto(),n,G.div({className:s,ref:"postArea"},this.state.shouldShowPostText?this._renderPostTextContainer():void 0,G.div({className:"comment-input-buttons"},this.props.shouldDisplayRegionCreationButton?this._renderRegionCreationButton():void 0,i?this._renderStickerButton():void 0,a?this._renderMentionsHelper():void 0),this.state.shouldShowPostButton?this._renderButtonsContainer():void 0))},_renderRegionCreationButton:function(){var t,e,s;return this.props.isRegionCreationEnabled?(s=j("Done commenting"),e="ic_comment_area_blue"):(s=j("Comment on specific areas"),e="ic_comment_area_dark"),t=o({"region-creation-button":!0,"comment-input-button":!0,"sprite-button":!0,"region-creation-enabled":this.props.isRegionCreationEnabled}),G.div({className:t,onClick:this._onRegionCreationClick},n.createElement(v,{content:s,position:v.POSITIONS.BOTTOM_ALIGN_RIGHT},G.button({className:"region-creation-image sprite-button"},n.createElement(A,{group:"web",name:e,alt:s}))))},_getArrowPosition:function(){var t,e;return t=this.props.shouldPopupsDropdown?"top":"bottom",e=this.props.isCommentsServerView?"left":"right",t+"-"+e},_onStickerDropdownShown:function(){return this.setState({stickerPopupShown:!0}),this.props.onStickerDropdownShown()},_onStickerDropdownHidden:function(){return this.setState({stickerPopupShown:!1}),this.props.onStickerDropdownHidden()},_renderStickerButton:function(){var t,e,o,s;return o="ic_sticker",this.state.stickerPopupShown&&(o="ic_sticker_blue"),t=G.button({className:"comment-sticker-add sprite-button"},n.createElement(A,{group:"web",name:o,alt:j("Add sticker")})),e=this.props.isCommentsServerView?-38:1,s=this.props.shouldPopupsDropdown?4:-11,G.div({className:"sticker-button comment-input-button sprite-button",onMouseDown:this.refreshDropdownDirection},n.createElement(v,{content:j("Add sticker"),position:v.POSITIONS.BOTTOM_ALIGN_RIGHT},n.createElement(E,{targetButton:t,ref:"stickerDropdown",arrow_position:this._getArrowPosition(),vertical_displacement:s,extra_css_class:"stickers-bubble-dropdown",horizontal_displacement:e,anchor_bottom:!this.props.shouldPopupsDropdown,bubbleDropdownShown:this._onStickerDropdownShown,bubbleDropdownHidden:this._onStickerDropdownHidden,bubbleDropdownScrollable:!0,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},n.createElement(z,{isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker}))))},_renderMentionsHelper:function(){var t,e,o,s;return o=null!=this.props.usersToNotify?this.props.usersToNotify:[],s="s_add_mention",this.state.selectorPopupShown&&(s="s_add_mention_blue"),t=G.button({className:"comment-mention-hint-add sprite-button"},n.createElement(A,{group:"web",name:s,alt:j("@mention someone")})),e=this.props.shouldPopupsDropdown?0:-16,G.div({className:"comment-mention-hint comment-input-button"},n.createElement(v,{position:v.POSITIONS.BOTTOM_ALIGN_RIGHT,content:j("@mention someone")},G.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},n.createElement(E,{targetButton:t,autofocus:!0,ref:"mentionsHintDropdown",arrow_position:this._getArrowPosition(),vertical_displacement:e,horizontal_displacement:this.props.isCommentsServerView?1:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden,bubbleDropdownShown:this._contactsSelectorPopupShown,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},n.createElement(w,{key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:!1,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(o),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isDemoMode:this.props.isDemoMode})))))},_renderCommenterPhoto:function(){var e,o,n,s;return e={dimension:32,defaultAvatar:new U({dimension:32,shape:"CIRCLE",initials:this.props.user.initials||"?",name:this.props.user.getDisplayIdentity()})},this.props.shouldHidePhotoAvatars||(e.photoUrl=this.props.user.photo_circle_url),n=null!=(s=this.props.user)?s.id:void 0,o=t.call(k.get_viewer().get_user_ids(!0),n)>=0?K(e):D(e),G.div({className:"commenter-photo"},this.props.shouldShowAvatar?o:void 0)},_renderCancelButton:function(){return G.a({className:"cancel-button",onMouseUp:this._onCancelMouseUp},j("Cancel"))},_renderButtonsContainer:function(){var t,e,o;return e=this.state.inputIsEmpty||this.props.isOffline,t={className:"post-button",disabled:e,ref:"postButton"},o=W(t,j("Post")),G.div({className:"button-container"},o,this.props.shouldEnableCancelButton?this._renderCancelButton():void 0)},_onCancelTextMouseUp:function(){return this._clearText(),this.setState({shouldShowPostText:!1})},_renderPostTextContainer:function(){return G.div({className:"post-text-container"},G.button({className:"post-button button-as-link",ref:"postButton"},j("Post")),G.span({}," • "),G.button({className:"button-as-link",onMouseUp:this._onCancelTextMouseUp},j("Cancel")))},render:function(){var t;return t=o({"comment-field":!0,"comment-field--reply":this.props.isReplyInput,"comment-field--disabled":this.props.isOffline}),G.div({className:t},this._renderShowNewComment(),this._renderCommentBox(),this.props.isCommentInputDisabled||this.props.isOffline?G.div({className:"comment-field__diabled"},""):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector",["external/classnames","external/react","external/react-dom","jquery","modules/clean/keycode","modules/clean/ajax","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/demo_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar_with_color","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/exception","modules/core/user_i18n"],function(e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,assert,g){var y,v,C,b,T,S,w;return v=i.KeyCode,w=l.demoBloodhound,C=m.LinkedProfileServices,T=m.ProfileServicesLinkingHandler,S=o.DOM,b=5,y=99,3,o.createClass({displayName:"ContactsSelector",propTypes:{showNullHint:o.PropTypes.bool,contactSelectedCallback:o.PropTypes.func,contactHighlightedCallback:o.PropTypes.func,contactSearchLogger:o.PropTypes.object,noAtMentionTriggerCallback:o.PropTypes.func,resultsLimit:o.PropTypes.number,matchFullQUery:o.PropTypes.bool,noMatchesText:o.PropTypes.string,user:o.PropTypes.object,showContactsInNullState:o.PropTypes.bool,x_offset:o.PropTypes.number,y_offset:o.PropTypes.number,enableImport:o.PropTypes.bool,show_contacts:o.PropTypes.bool,should_dropdown:o.PropTypes.bool,last_keydown:o.PropTypes.number,extraContacts:o.PropTypes.arrayOf(o.PropTypes.object),shouldHidePhotoAvatars:o.PropTypes.bool,isDemoMode:o.PropTypes.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&!this.props.isDemoMode&&(this.profile_services=C.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:f._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1,isDemoMode:!1}},componentWillMount:function(){if(this.props.isDemoMode?this.contacts=w:(this.contacts=new a,this.contacts.setExtraContacts(this.props.extraContacts)),0===this.state.query.length&&this.props.showContactsInNullState)return this.get_suggestions("")},componentDidMount:function(){if(this.$typeahead_container=s(n.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=s(n.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),!this.state.show_contacts)return this._reset_import_state()},componentWillReceiveProps:function(t){if(this.props.isDemoMode||this.contacts.setExtraContacts(t.extraContacts),0===this.state.query.length&&t.showContactsInNullState!==this.props.showContactsInNullState)return this.get_suggestions("")},componentDidUpdate:function(t,e){var o;return this.$typeahead_container=s(n.findDOMNode(this.refs.suggestionsContainer)),this.$typeahead_suggestions=s(n.findDOMNode(this.refs.suggestionsList)),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof(o=this.props).contactHighlightedCallback?o.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(t){var e,o,n,s;for(n=h.importable_contact_services(),e=0,o=n.length;e<o;e++)s=n[e],t.push(this._append_provider(s));return t},_append_provider:function(t){var e;return e=h.to_name(t),this.profile_services.service_is_connected(t)&&(e+=f._(" (Connected)")),{type:y,provider:t,name:e,photo_url:h.to_img(t)[0]}},_import_contacts_mouseover:function(t){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(t){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(t){return t.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(t){if(null!=t&&this.state.focused_row!==t||null===t)return this.setState({focused_row:t})},_focus_suggestion_row_mouseover:function(t){var e,o;if(e=s(t.currentTarget),o=e.index(),o>-1)return this._focus_suggestion_row(o)},_get_suggestion_row:function(t){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(t,e,o){var n,s,i,r,a;if(this.isMounted())return e=(function(){var t,o,n;for(n=[],t=0,o=e.length;t<o;t++)i=e[t],i.type!==u.NEW_STYLE_GROUP&&n.push(i);return n})(),e=c.sortContactsByTeamFirst(e),o||(e=t.length>=b?this._getApproximateNameMatches(t,e):this._getExactFirstOrLastNameMatches(t,e)),this.matchesCountFromBloodhoundContacts=e.length,e=e.slice(0,this.props.resultsLimit),r=e.length,a=0===r&&this.props.last_keydown!==v.SPACE&&t.indexOf(" ")<0||0===r&&this.props.matchFullQUery,o||"function"==typeof(s=this.props).noAtMentionTriggerCallback&&s.noAtMentionTriggerCallback(r),this.props.enableImport&&0===r&&!this.props.isDemoMode?e=this._append_import_to_suggestions(e):r>0&&this._reset_import_state(),this.props.should_dropdown?n=0:(n=e.length-1,e.reverse()),this.setState({suggestions:e,focused_row:n,show_no_results:a,matches_count:r})},_has_suggestion_row_at_index:function(t){return null!=t&&t>=0&&t<this.get_suggestions_count()},_mouse_down_select_suggestion:function(t){return t.preventDefault(),this.select_suggestion(t.currentTarget)},_position_contacts_list:function(){var t,e;return e=this.$typeahead_container.parent(),t=this.$typeahead_container.width(),t+this.props.x_offset>e.width()?this.$typeahead_container.css("left",e.width()-t):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(e,o){var n;return(function(){var s,i,r;for(r=[],s=0,i=o.length;s<i;s++)n=o[s],t.call(n.name_tokens,e)>=0&&r.push(n);return r})()},_getApproximateNameMatches:function(t,e){var o,n,s,i,r,a,l,c;for(a=[],o=0,s=e.length;o<s;o++)for(r=e[o],c=r.name_tokens,n=0,i=c.length;n<i;n++)if(l=c[n],0===l.indexOf(t)){a.push(r);break}return a},get_suggestions:function(t,e){if(null==e&&(e=!0),null!=this.props.user&&this.props.user.is_signed_in)return this.props.isDemoMode?this.contacts.search(t,(function(o){return function(n){return o._get_suggestions_callback(t,n,e)}})(this)):this.contacts.get(t,(function(o){return function(n){return o._get_suggestions_callback(t,n,e)}})(this)),this.setState({query:t})},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(t){var e,o,n,s;if(t.keyCode||t.which||t.charCode,t.keyCode===v.ENTER||t.keyCode===v.TAB){if(t.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row))return s=this._get_suggestion_row(this.state.focused_row),this.select_suggestion(s)}else if(((o=t.keyCode)===v.UP||o===v.DOWN)&&(e=this.get_suggestions_count(),e>0))if(t.keyCode===v.UP){if(n=null!=this.state.focused_row?this.state.focused_row:e,0!==this.state.focused_row)return this._focus_suggestion_row((n-1)%e)}else if(t.keyCode===v.DOWN&&(n=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==e-1))return this._focus_suggestion_row((n+1)%e)},select_suggestion:function(t){var e,o,n;return e=s(t),e.data("type")===y?void(null!=this.props.user&&this.props.user.is_signed_in&&(o=new T,o.auth_service_with_user(String(e.data("provider")),this.props.user.id,function(t){return T.show_import_notifications(t)},"contact-importer-modal"))):(null!=this.props.contactSearchLogger&&(n={sort_variant:null,context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:e.data("type"),contact_id:e.data("identifier"),contact_name:e.data("name"),did_select_suggestion:!0},this.props.contactSearchLogger.add_record(n)),null!=this.contactSelectedCallback&&this.contactSelectedCallback(e),this.isMounted()?this.setState({focused_row:null,suggestions:[]}):void 0)},render:function(){var t,n,s,i,r;return s=e({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),S.div({className:s,ref:"suggestionsContainer"},this.props.show_contacts&&this.props.user?this.props.user.is_signed_in?0===this.state.query.length&&this.props.showNullHint&&!this.props.showContactsInNullState?S.div({className:"suggestion-row empty-state-row"},f._("Mention someone by name or email")):this.state.query.length||0===this.state.query.length&&this.props.showContactsInNullState?(t=S.div({className:"suggestion-demo-hint"},f._("All names are examples. No one will be notified of your comment.")),n=S.div({ref:"suggestionsList"},function(){var t,n,i,a;for(i=this.state.suggestions,a=[],t=0,n=i.length;t<n;t++)r=i[t],a.push((function(t){return function(n){var i,r,a,l,c,h,m,_;return s={"import-row":n.type===y,"suggestion-row":!0,focused:null!=t.state.focused_row&&t.state.suggestions.indexOf(n)===t.state.focused_row},a=e(s),n.type===u.EMAIL?(m=n.email,l=n.email):n.type===u.FB?(m="fb_"+n.fb_id,l="Facebook Contact"):n.type===u.NEW_STYLE_GROUP?(m=n.group_id,l="Group"):n.type===y?(m="Import-"+n.name,r=S.img({src:n.photo_url})):n.type===u.DBX_ID&&(m=n.dbx_account_id,l=f._("Dropbox User")),c=!1,null!=n.name&&n.name.length>0?_=n.name:null!=n.email&&(c=!0,_=n.email,l=null),n.type===y||null==n.photo_url&&null==_||(h=c?"@":g.getInitials(_),i={dimension:32,defaultAvatar:o.createElement(d,{dimension:32,shape:"CIRCLE",initials:h,name:_})},t.props.shouldHidePhotoAvatars||(i.photoUrl=n.photo_url),r=o.createElement(p,i)),S.div({key:m,className:a,"data-identifier":m,"data-name":_,"data-type":n.type,"data-photo-url":n.photo_url,"data-dbx-account-id":n.dbx_account_id||null,"data-provider":n.provider||null,onMouseDown:function(e){return t._mouse_down_select_suggestion(e)},onMouseEnter:function(e){return t._focus_suggestion_row_mouseover(e)}},S.div({className:"suggestion-wrapper"},r?S.div({className:"suggestion-avatar"},r):void 0,S.div({className:"suggestion-info"},null!=_?S.div({className:"suggestion-name"},_):void 0,null!=l?S.div({className:"suggestion-identifier"},l):void 0)))}})(this)(r));return a}.call(this),this.props.isDemoMode?t:void 0),this.state.show_no_results?S.div({},S.div({className:"suggestion-row empty-state-row"},S.div({className:"empty-state-row-text"},this.state.hover_import_contact||this.state.show_import_list?f._("Import Contacts"):this.props.noMatchesText),this.props.enableImport?(i={"import-contacts":!0,active:null!=this.state.show_import_list},S.a({className:e(i),onMouseDown:(function(t){return function(e){return t._mouse_down_import_contacts(e)}})(this),onMouseEnter:(function(t){return function(e){return t._import_contacts_mouseover(e)}})(this),onMouseLeave:(function(t){return function(e){return t._import_contacts_mouseleave(e)}})(this)},o.createElement(_,{group:"web",name:"user_add",alt:f._("Import Contacts")}))):void 0),this.state.show_import_list?S.div({className:e({"suggestion-row-top-divider":!0,"animating-down":this.props.should_dropdown,"animating-up":!this.props.should_dropdown})},n):void 0):this._matches_count()>0?n:void 0):void 0:S.div({className:"suggestion-row empty-state-row"},f._("Login to @mention your contacts")):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector_popup",["jquery","external/react","external/react-dom","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/validators/validators"],function(e,o,n,s,i,r,a,l,c,u){var p,d,h,m;return p=l.KeyCode,d=o.DOM,m=[p.UP,p.DOWN,p.ESC,p.ENTER,p.TAB],h=u.check(u.create(["EmailValidator"])),o.createClass({displayName:"ContactsSelectorPopup",propTypes:{showContactsInNullState:o.PropTypes.bool,shouldShowNoNotifyHint:o.PropTypes.bool,should_dropdown:o.PropTypes.bool,user:o.PropTypes.object,contactHighlightedCallback:o.PropTypes.func,contactSelectedCallback:o.PropTypes.func,contactSearchLogger:o.PropTypes.object,emailEnteredCallback:o.PropTypes.func,clearContactHighlightedCallback:o.PropTypes.func,onAddPeopleMouseUp:o.PropTypes.func,onSkipAddMention:o.PropTypes.func,enableImport:o.PropTypes.bool,extraContacts:o.PropTypes.arrayOf(o.PropTypes.object),shouldHidePhotoAvatars:o.PropTypes.bool,isDemoMode:o.PropTypes.bool},getInitialState:function(){return{query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1}},getDefaultProps:function(){return{showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,isDemoMode:!1}},showNoNotifyHint:function(){var t;return this.setState({shouldShowNoNotifyHint:!0}),"function"==typeof(t=this.props).clearContactHighlightedCallback?t.clearContactHighlightedCallback():void 0},contactHighlightedCallback:function(t){var e;return i.assert(!this.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof(e=this.props).contactHighlightedCallback?e.contactHighlightedCallback(t):void 0},contactSelectedCallback:function(t){var e;return this._resetInput(),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(t):void 0},_resetInput:function(){return this.setState({query:""}),e(n.findDOMNode(this.refs.contactSelectorPopupInput)).val(""),this.refs.contactSelectorPopup.get_suggestions("")},_logEmailEntered:function(t){var e;if(null!=this.props.contactSearchLogger)return e={sort_variant:null,context:"mentions",contact_type:a.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)},_onInputKeyDown:function(t){var e,o,n;if(o=t.keyCode||t.which||t.charCode,null!=s.msie&&o===p.ENTER){if(n=t.target.value,this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(t);if(h(n))return"function"==typeof(e=this.props).emailEnteredCallback&&e.emailEnteredCallback(n),this._logEmailEntered(n)}},_onInputKeyUp:function(e){var o,n,s;if(n=e.keyCode||e.which||e.charCode,s=e.target.value,null!=this.refs.contactSelectorPopup){if(!(t.call(m,n)>=0))return this.setState({query:s}),this.refs.contactSelectorPopup.get_suggestions(s);if(this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(n===p.ENTER&&h(s))return"function"==typeof(o=this.props).emailEnteredCallback&&o.emailEnteredCallback(s),this._logEmailEntered(s)}},_onAddPeopleMouseUp:function(t){var o;return this.setState({shouldShowNoNotifyHint:!1},(function(t){return function(){return e(n.findDOMNode(t.refs.contactSelectorPopupInput)).focus()}})(this)),"function"==typeof(o=this.props).onAddPeopleMouseUp?o.onAddPeopleMouseUp(t):void 0},_onSkipAddMention:function(t){var e;return"function"==typeof(e=this.props).onSkipAddMention?e.onSkipAddMention(t):void 0},render:function(){var t,e,n;return d.div({className:"contacts-selector-popup"},this.state.shouldShowNoNotifyHint?d.div({className:"contacts-selector-hint"},"Your comment won't notify anyone.",d.div({}),d.a({className:"",onMouseUp:this._onAddPeopleMouseUp},"Add people"),d.span({className:"bottom-dot"}," · "),d.a({className:"just-for-me",onMouseUp:this._onSkipAddMention},"Just for me")):(e=d.div({className:"contacts-selector-popup-input-wrapper"},d.input({ref:"contactSelectorPopupInput",onKeyDown:this._onInputKeyDown,onKeyUp:this._onInputKeyUp,placeholder:"Type an email or name"})),t=this.state.query.trim().length>0||this.props.showContactsInNullState?d.hr({className:"separator"}):d.span({}),n=o.createElement(c,{ref:"contactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,contactHighlightedCallback:this.contactHighlightedCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.should_dropdown,y_offset:0,x_offset:0,user:this.props.user,last_keydown:this.state.last_keydown,showNullHint:!1,showContactsInNullState:this.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isDemoMode:this.props.isDemoMode}),this.props.should_dropdown?[e,t,n]:[n,t,e]))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,o=this.length;e<o;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/mentions_controller",["jquery","external/classnames","external/react","external/react-dom","external/purify","modules/core/browser","modules/core/exception","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/validators/validators","modules/clean/react/activity/contacts_selector"],function(e,o,n,s,i,r,a,l,c,u,p,d){var h,m,_,f,g,y,v,C,b,T,S;return h=l.ActivityUser,f=u.KeyCode,v=n.DOM,m=n.createFactory(d),C="\ufeff",b=new RegExp(C,"g"),g=" ",y="",_="",T=[f.UP,f.DOWN,f.ESC,f.ENTER,f.TAB],S=p.check(p.create(["EmailValidator"])),n.createClass({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:n.PropTypes.bool,enableNoAtMentions:n.PropTypes.bool,initialText:n.PropTypes.string,user:n.PropTypes.object,
position_contacts_callback:n.PropTypes.func,showMentionsHelper:n.PropTypes.bool,contactSearchLogger:n.PropTypes.object,contactsSelectorPopupShown:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,onKeyDown:n.PropTypes.func,onKeyUp:n.PropTypes.func,onAtSignKeyPress:n.PropTypes.func,onNoAtSignKeyPress:n.PropTypes.func,onBlur:n.PropTypes.func,onFocus:n.PropTypes.func,onPaste:n.PropTypes.func,onCancel:n.PropTypes.func,onMention:n.PropTypes.func,placeholder_text:n.PropTypes.string,resultsLimit:n.PropTypes.number,resizeCallback:n.PropTypes.func,shouldInitiallyFocusInput:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,showPlaceholderText:n.PropTypes.bool,isDemoMode:n.PropTypes.bool,shouldDisableHighlight:n.PropTypes.bool,onEditModeChange:n.PropTypes.func},getInitialState:function(){var t;return t=this.props.shouldAlwaysInEditMode,this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(t=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:t,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new h,resultsLimit:5,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1,shouldDisableHighlight:!1}},componentDidMount:function(){if(this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=r.mozilla?setTimeout((function(t){return function(){return t._initializeInputWithText(t.props.initialText)}})(this),0):this._initializeInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput)return setTimeout((function(t){return function(){return t.focusInput()}})(this),0)},componentDidUpdate:function(t,e){var o,n;if(this._componentSetup(),n=this._getCaretPosition(),e.show_contacts!==this.state.show_contacts&&((null!=n?n.left:void 0)!==this.state.x_offset||(null!=n?n.top:void 0)!==this.state.y_offset))return o={x_offset:n.left,y_offset:n.top},this.setState(o)},_resetInputToPlaceholderState:function(){var t;return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1}),"function"==typeof(t=this.props).onEditModeChange?t.onEditModeChange(!1):void 0},_initializeInputWithText:function(t){var e,o,n,s;if(t=i.sanitize(t,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus(),n=this.$text_input.get(0),s=document.createRange(),n&&(s.setStart(n,0),o=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,t=t.replace(o,(function(t){return function(e,o,n){return o=o.trim(),n=n.trim(),t._mentionWrapper(o,n)}})(this)),this.unsafeInsertHtmlAtRange(t,s,!0),!this.state.in_edit_mode))return this.setState({in_edit_mode:!0}),"function"==typeof(e=this.props).onEditModeChange?e.onEditModeChange(!0):void 0},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=e(s.findDOMNode(this.refs.input)),this.$text_input=e(s.findDOMNode(this.refs.textInput))},_logEmailEntered:function(t){var e;if(null!=this.props.contactSearchLogger)return e={sort_variant:null,context:"mentions",contact_type:c.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)},_parseInputTextAndReplace:function(){var t,e;if(t=0,e=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi),this._parseInputTextWithRegex(e,(function(e){return function(o,n){var s,i,a,l,c;if(i=o[0],s=o.index,l=i.substring(1),S(l)&&null==r.msie)return c=document.createRange(),c.setStart(n,s),c.setEnd(n,s+i.length),a=e.createMentionObject(l,l),e._addMentionIntoInput(a,c),t++,e._logEmailEntered(l)}})(this)),t>0)return this.setCursorToEndOfInput()},_parseInputTextWithRegex:function(t,o){var n,s,i,a,l,c,u,p;if(s=this.$text_input.html().replace(b,""),null!=s&&""!==s){for(l=this.$text_input[0].childNodes,u=[],i=0,a=l.length;i<a;i++)n=l[i],null!=r.msie&&e(n).is("p")||n.nodeType===Node.TEXT_NODE&&""!==n.nodeValue.trim()?(p=null!=r.msie?e(n).text():n.nodeValue,u.push((function(){var e;for(e=[];null!==(c=t.exec(p));)e.push(o(c,n));return e})())):u.push(void 0);return u}},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).position_contacts_callback?t.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(_)},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(y)},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var t,e;return e=this._getStartRangeUnicodeIndex(),t=this._getEndRangeUnicodeIndex(),e>=0&&t>0&&t>e},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(t){var e,o,n,s,r;if(this._getStartRangeUnicodeIndex()>=0)return r=this._getStartRangeUnicodeIndex(),o=this.$text_input.html(),e=o.substr(0,r),n=o.substr(r),t=i.sanitize(t),s=""+e+t+n,this._dangerouslySetInputHtml(s)},_dangerouslyReplaceStartToEndRangeUnicode:function(t){var e,o,n,s,r;if(this._startAndEndRangeUnicodeExistsAndValid())return r=this._getStartRangeUnicodeIndex(),o=this._getEndRangeUnicodeIndex(),s=this.$text_input.html(),n=s.substr(0,r),e=s.substr(o),t=i.sanitize(t),this._dangerouslySetInputHtml(""+n+y+t+_+e)},_clearRangeUnicode:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u0091/g,""),t=t.replace(/\u0092/g,""),this.$text_input.html(t)},_dangerouslyInsertLiveTextWithRangeUnicode:function(t){var e;return null==r.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),this._dangerouslySetInputHtml(""+this.$text_input.html()+y+_)),e=this._isSpaceBeforeStartUnicode()?"":" ",t=i.sanitize(t),this._dangerouslyReplaceStartToEndRangeUnicode(""+e+t)},_getRangeBetweenStartEndRangeUnicode:function(){var t,o,n,s,i,a,l,c,u;if(o=this.$text_input.html().replace(b,""),null!=o&&""!==o)for(l=this.$text_input[0].childNodes,s=0,i=l.length;s<i;s++)if(t=l[s],u=null!=r.msie?e(t).text():t.nodeValue,null!=u&&u.length>0&&(c=u.indexOf(y),n=u.indexOf(_),c>=0&&n>0&&n>c))return a=document.createRange(),a.setStart(t,c),a.setEnd(t,n),a},_isSpaceBeforeStartUnicode:function(){var t;return t=this._getStartRangeUnicodeIndex(),t>=0&&this._isSpaceBeforeIndex(t)},_isSpaceBeforeIndex:function(t){var e;return e=this.$text_input.html(),t>0&&" "===e.substr(t-1,1)||t>=6&&"&nbsp;"===e.substr(t-6,6)},_dangerouslySetInputHtml:function(t){return this.$text_input.html(t)},contactsSelectorPopupHidden:function(){if(this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=s.findDOMNode(this.refs.textInput))return this.setCursorToEndOfInput()},contactsSelectorPopupShown:function(t){var e,o,n;if(this.isMounted()&&this.props.showMentionsHelper)return this.state.in_edit_mode||this._clearDefaultState(),e=null!=t&&null!=(o=t.refs)?o.contactSelectorPopupInput:void 0,null!=(n=s.findDOMNode(e))?n.focus():void 0},clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},contactHighlightedCallback:function(t){var e,o;return o=(null!=t?t.data("name"):void 0)||"",(null!=t?t.data("identifier"):void 0)||"",this._dangerouslyInsertLiveTextWithRangeUnicode("@"+o),"function"==typeof(e=this.props).onContactsSelectorSuggestionsUpdate?e.onContactsSelectorSuggestionsUpdate():void 0},_contactSelectedCallback:function(t){var e;return this._addMentionIntoInput(this.createMentionObjectFromSuggestion(t)),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(this.isInNoAtMentionMode):void 0},addMentionIntoRangeUnicode:function(t){var e;if(this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" "),e=this._getRangeBetweenStartEndRangeUnicode())return this._addMentionIntoInput(t,e),this._clearRangeUnicode()},_noAtMentionTriggerCallback:function(t){var e;if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&t>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof(e=this.props).onNoAtSignKeyPress?e.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===t)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){return setTimeout((function(t){return function(){var e,o;if(t.focusInput(),e=t.$text_input[0].lastChild,null!=e)return o=document.createRange(),o.selectNode(e),o=o.cloneRange(),o.setStartAfter(e),o.collapse(!1),t._selection().removeAllRanges(),t._selection().addRange(o)}})(this),10)},_getCaretPosition:function(){var t,e,o,n;return e=null!=(n=s.findDOMNode(this.refs.container))?n.getClientRects()[0]:void 0,t={left:this.state.x_offset,top:this.state.y_offset},this._selection().rangeCount>0&&(o=this._selection().getRangeAt(0).getClientRects()[0],null!=o&&null!=e&&(t.left=o.left-e.left,this.props.shouldPopupsDropdown?t.top=o.bottom-e.top:t.top=o.top-e.top)),t},unsafeInsertHtmlAtRange:function(t,o,n){var s,i,r,a;for(o.deleteContents(),a=e("<span />").html(t)[0],s=document.createDocumentFragment();r=a.firstChild;)i=s.appendChild(r);return o.insertNode(s),i&&n&&(o=o.cloneRange(),o.setStartAfter(i),o.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(o)),i},_checkEndOfLine:function(){var t,o,n,s;if(a.assert(null!=r.mozilla,"_checkEndOfLine called from non mozilla browser"),s=this._extractCursorInfo(),o=s[0],n=s[1],s[2],e(o).hasClass("text-input")&&e(this.$text_input.contents()[n]).is("br")&&n>0&&(t=this.$text_input.contents()[n-1],t.nodeType===Node.TEXT_NODE&&t.nodeValue===C))return this._setCursorLocation(t,0)},_selection:function(){return window.getSelection()},_setCursorLocation:function(t,o){var n;if(null!=t){if(n=document.createRange(),t.nodeType===Node.TEXT_NODE)n.setStart(t,o);else{if(!e(t).hasClass("new-mention"))return;0===o?n.setStartBefore(t):n.setStartAfter(t)}return n.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(n)}},_updateCurrentWordBoundary:function(){var t,e,o,n,s,i;return o=this._extractCursorInfo(),o[0],e=o[1],n=o[2],i=n.slice(0,e).lastIndexOf(" ")+1,t=n.slice(0,e).lastIndexOf(g)+1,t>i&&(i=t),s=n.slice(e).indexOf(" "),s=s===-1?n.length:e+s,this.currentCursorWordStartPosition=i,this.currentCursorWordEndPosition=s},_cleanMentionHighlighting:function(t){var o,n,s,i,r;for(null==t&&(t=null),n=this.$text_input.children(),null!=t&&(n=[t]),r=[],s=0,i=n.length;s<i;s++)o=n[s],r.push(e(o).removeClass("selected"));return r},_cleanUpNbsp:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u00a0/g," "),t=t.replace(/\s{2,}/g," "),this.$text_input.html(t)},_cleanUpDelimiters:function(){var t,o,n,s,l,c,u,p,d;for(a.assert(null==r.msie,"_cleanUpDelimiters() called from MSIE"),c=this._extractCursorInfo(),s=c[0],l=c[1],c[2],u=this.$text_input.contents(),o=0,n=u.length;o<n;o++)t=u[o],t.nodeType===Node.TEXT_NODE?(t.nodeValue=t.nodeValue.replace(b,""),""===t.nodeValue&&(t!==s?t.parentNode.removeChild(t):l=0)):e(t).hasClass("new-mention")&&(d=document.createTextNode(i.sanitize(C)),t.parentNode.insertBefore(d,t),p=document.createTextNode(i.sanitize(C)),t.parentNode.insertBefore(p,t.nextSibling));if(null!=s&&s.nodeType===Node.TEXT_NODE&&s.nodeValue.length<l&&(l=s.nodeValue.length),this._setCursorLocation(s,l),null==r.mozilla&&null!=s&&""===s.nodeValue)return s.parentNode.removeChild(s)},_checkAndMergeAdjacentNodes:function(){var t,o,n,s,i,l,c,u,p;if(a.assert(null!=r.msie,"_checkAndMergeAdjacentNodes called from non IE browser"),u=this._extractCursorInfo(),i=u[0],l=u[1],u[2],(e(i).hasClass("text-input")||e(i).is("p"))&&((p=event.keyCode)===f.BACKSPACE||p===f.DELETE)&&(t=e(i).contents()[l],(null!=t?t.nodeType:void 0)===Node.TEXT_NODE))return n=t.nodeValue,o=0,c=t.previousSibling,s=t.nextSibling,null!=c&&c.nodeType===Node.TEXT_NODE&&(o=c.nodeValue.length,n=c.nodeValue+n,c.parentNode.removeChild(c)),null!=s&&s.nodeType===Node.TEXT_NODE&&(n+=s.nodeValue,s.parentNode.removeChild(s)),t.nodeValue=n,this._setCursorLocation(t,o)},_isCursorAfterSpaceOrBeginningOfLine:function(t,e){var o;if(e-1>=0){if(o=t.slice(e-1,e)," "===o||""===o||" "===o)return!0}else if(0===e)return!0;return!1},_extractCursorInfo:function(){var t,e,o;return t=this._selection().focusNode,e=this._selection().focusOffset,o="",null!=t&&t.nodeType===Node.TEXT_NODE&&(o=t.nodeValue.length?t.nodeValue:""),[t,e,o]},_clearDefaultState:function(){var t;if(this.state.default_state&&this._clearInputWithoutBlurring(),!this.state.in_edit_mode)return this.setState({in_edit_mode:!0}),"function"==typeof(t=this.props).onEditModeChange?t.onEditModeChange(!0):void 0},_clearInputWithoutBlurring:function(){return null!=r.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){var t;return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:this.props.shouldAlwaysInEditMode}),"function"==typeof(t=this.props).onEditModeChange&&t.onEditModeChange(this.props.shouldAlwaysInEditMode),this.$text_input.blur()},_onInputKeydownMozilla:function(t){var e,o,n,s,i,l,c,u;if(a.assert(null!=r.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine(),i=this._extractCursorInfo(),o=i[0],n=i[1],u=i[2],null!=o&&o.nodeType===Node.TEXT_NODE)if(s=o.previousSibling,e=o.nextSibling,(l=t.keyCode)===f.DELETE||l===f.RIGHT){if(u===C&&null!=e&&this._toggleMentionSelectState(e,t))return this._setCursorLocation(o,1);if(u.length!==n||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==C)return this._cleanMentionHighlighting();if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t))return this._setCursorLocation(e,1)}else if(((c=t.keyCode)===f.BACKSPACE||c===f.LEFT)&&0===n&&null!=s){if(u===C&&this._toggleMentionSelectState(s,t))return this._setCursorLocation(o,0);if(s.nodeType===Node.TEXT_NODE&&s.nodeValue===C&&null!=s.previousSibling&&this._toggleMentionSelectState(s.previousSibling,t))return this._setCursorLocation(s,0)}},_onInputKeydownMsie:function(t){var o,n,s,i,l,c,u,p,d,h,m;if(a.assert(null!=r.msie,"_onInputKeydownMsie called from non MSIE browser"),c=this._extractCursorInfo(),s=c[0],i=c[1],m=c[2],null!=s){if(e(s).hasClass("text-input")||e(s).is("p"))return o=e(s).contents(),((u=t.keyCode)===f.BACKSPACE||u===f.LEFT)&&i>0&&e(o[i-1]).hasClass("new-mention")?this._toggleMentionSelectState(o[i-1],t):(p=t.keyCode)!==f.DELETE&&p!==f.RIGHT||!e(o[i]).hasClass("new-mention")?this._cleanMentionHighlighting():this._toggleMentionSelectState(o[i],t);if(l=s.previousSibling,n=s.nextSibling,(d=t.keyCode)===f.BACKSPACE||d===f.LEFT){if(0===i&&null!=l&&e(l).hasClass("new-mention"))return this._toggleMentionSelectState(l,t)}else{if((h=t.keyCode)!==f.DELETE&&h!==f.RIGHT)return this._cleanMentionHighlighting();if(i===m.length&&null!=n&&e(n).hasClass("new-mention"))return this._toggleMentionSelectState(n,t)}}},_onInputKeydownWebkit:function(t){var e,o,n,s,i,l,c,u;if(a.assert(null!=r.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters(),i=this._extractCursorInfo(),o=i[0],n=i[1],u=i[2],null!=o&&o.nodeType===Node.TEXT_NODE)if(s=o.previousSibling,e=o.nextSibling,(l=t.keyCode)===f.BACKSPACE||l===f.LEFT){if(null!=s&&u===C&&this._toggleMentionSelectState(s,t)){if(t.keyCode===f.BACKSPACE)return this._setCursorLocation(o,n-1);if(t.keyCode===f.LEFT)return this._setCursorLocation(s.previousSibling,1)}}else{if((c=t.keyCode)!==f.DELETE&&c!==f.RIGHT)return this._cleanMentionHighlighting();if(n!==u.length||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==C&&0!==e.nodeValue.length){if(u===C&&0===n&&null!=e&&this._toggleMentionSelectState(e,t)){if(t.keyCode===f.DELETE)return this._setCursorLocation(o,1);if(t.keyCode===f.RIGHT)return this._setCursorLocation(e,1)}}else if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t)){if(t.keyCode===f.DELETE)return this._setCursorLocation(e,1);if(t.keyCode===f.RIGHT)return this._setCursorLocation(e.nextSibling,1)}}},_onInputKeydown:function(e){var o,n,s,i,a,l,c,u;if(i=this._normalizeKeycode(e),this.setState({default_state:!1,last_keydown:i}),i!==f.PROCESSING)if(!(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)||i!==f.BACKSPACE&&i!==f.DELETE&&i!==f.LEFT&&i!==f.RIGHT?this._cleanMentionHighlighting():null!=r.webkit?this._onInputKeydownWebkit(e):null!=r.mozilla?this._onInputKeydownMozilla(e):null!=r.msie&&this._onInputKeydownMsie(e),"function"==typeof(o=this.props).onKeyDown&&o.onKeyDown(e),c=this._extractCursorInfo(),a=c[0],l=c[1],u=c[2],this.state.show_contacts){if(t.call(T,i)>=0){if(e.preventDefault(),i===f.ESC||0===this.contacts_selector.get_suggestions_count()&&i===f.ENTER)return this.setState({show_contacts:!1})}else if(i===f.BACKSPACE&&(null!=a?a.nodeType:void 0)===Node.TEXT_NODE&&l>0&&(s=u.substr(l-1,1),"@"===s&&this._isCursorAfterSpaceOrBeginningOfLine(u,l-1)))return this.setState({show_contacts:!1})}else if(i===f.ESC)return"function"==typeof(n=this.props).onCancel?n.onCancel():void 0},_onInputKeypress:function(t){var o,n,s,i,a,l,c,u,p;if(u=this._extractCursorInfo(),l=u[0],c=u[1],p=u[2],this._normalizeKeycode(t)===f.AT_SIGN&&!this.state.mention_triggered&&("function"==typeof(o=this.props).position_contacts_callback&&o.position_contacts_callback(),i=!1,l.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(p,c)&&(i=!0,s=c):(e(l).hasClass("text-input")||null!=r.msie&&e(l).is("p"))&&(i=!0,s=0),i))return a={search_start_position:s,search_end_position:s,mention_triggered:!0},this.setState(a),"function"==typeof(n=this.props).onAtSignKeyPress?n.onAtSignKeyPress():void 0},_onInputKeyup:function(e){var o,n,s,i,l,c,u,p,d,h,m,_;if(this.state.last_keydown===f.PROCESSING)return void a.assert(null!=r.webkit,"PROCESSING keycode detected in non-webkit browser");if(null!=r.msie&&this._checkAndMergeAdjacentNodes(),p=this._extractCursorInfo(),l=p[0],c=p[1],_=p[2],this.props.enableNoAtMentions&&this._updateCurrentWordBoundary(),i={},this.state.mention_triggered&&(i.mention_triggered=!1,i.show_contacts=!0,c-this.state.search_start_position>1&&(n=_.slice(this.state.search_start_position+1,c).indexOf("@"),i.show_contacts=n===-1)),!this.state.show_contacts&&!i.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(h=e.keyCode,t.call(T,h)>=0&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(e):e.keyCode!==f.ESC&&this.contacts_selector.get_suggestions(_.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(d=e.keyCode,t.call(T,d)>=0&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(e);else if(c<=this.state.search_start_position||l.nodeType!==Node.TEXT_NODE)i.show_contacts=!1;else if(e.keyCode===f.SPACE)if(u=this._parseMentionQuery(_,this.state.search_end_position).trim(),0!==u.length){if(S(u))return s=this.createMentionObject(u),this._addMentionIntoInput(s),void this._logEmailEntered(u);this.contacts_selector.get_suggestions(u,!0)}else this.setState({show_contacts:!1});else this.contacts_selector.get_suggestions(this._parseMentionQuery(_,c).trim(),!0);return e.keyCode!==f.ENTER&&e.keyCode!==f.TAB&&(e.keyCode!==f.SPACE||this.state.show_contacts||i.show_contacts)||this._parseInputTextAndReplace(),null==r.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof(o=this.props).onKeyUp&&o.onKeyUp(e),m=this._normalizeKeycode(e),t.call(T,m)>=0&&this.state.show_contacts?void 0:this.setState(i,(function(t){return function(){var e;return"function"==typeof(e=t.props).resizeCallback?e.resizeCallback():void 0}})(this))},_normalizeKeycode:function(t){return t.keyCode||t.which||t.charCode},_onInputBlur:function(t){var e,o,n;return this._parseInputTextAndReplace(),"function"==typeof(e=this.props).onBlur&&e.onBlur(),n={show_contacts:!1,default_state:!1},!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(n.in_edit_mode=!1,n.search_end_position=-1,n.search_start_position=-1,"function"==typeof(o=this.props).onEditModeChange&&o.onEditModeChange(!1)),this.setState(n)},_onInputFocus:function(t){var e,o,n;if(t.target===this.$text_input.get(0))return"function"==typeof(e=this.props).onFocus&&e.onFocus(),n={show_contacts:!1},this.state.in_edit_mode||(n.in_edit_mode=!0,n.search_end_position=-1,n.search_start_position=-1,"function"==typeof(o=this.props).onEditModeChange&&o.onEditModeChange(!0)),setTimeout((function(t){return function(){if(t.isMounted())return t.setState(n)}})(this),0)},_onInputMouseDown:function(t){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(t){var e;return this.setState({default_state:!1}),"function"==typeof(e=this.props).onPaste?e.onPaste(t):void 0},createMentionObjectFromSuggestion:function(t){var e,o,n;return n=t.data("name"),o=t.data("identifier"),e=t.data("dbx-account-id"),this.createMentionObject(o,n,e)},createMentionObject:function(t,e,o){return null==e&&(e=null),null==o&&(o=null),e||(e=t),o&&(t=o),{name:e,identifier:t,dbx_account_id:o}},_toggleMentionSelectState:function(t,o){if(e(t).hasClass("new-mention")){if(e(t).hasClass("selected"))return this._cleanMentionHighlighting(t),!0;o.stopPropagation(),o.preventDefault(),e(t).addClass("selected")}return!1},_onMentionMouseDown:function(t){var e;return t.preventDefault(),t.stopPropagation(),0===t.button?(this._cleanMentionHighlighting(),this._toggleMentionSelectState(t.target,t),e=document.createRange(),e.selectNode(t.target),this._selection().removeAllRanges(),this._selection().addRange(e)):null!=r.mozilla&&2===t.button?this._setCursorLocation(t.target,1):void 0},_mentionWrapper:function(t,e,o){return null!=r.webkit?"<span class='new-mention' data-id=\""+t+'" data-name="'+e+'" data-dbx-account-id="'+o+'">'+e+"</span>":'<input type="button" class=\'new-mention\' data-id="'+t+'" data-name="'+e+'" data-dbx-account-id="'+o+'" value="'+e+'"></input>'},_parseMentionQuery:function(t,e){var o;return e>this.state.search_end_position?this.setState({search_end_position:e}):e=this.state.search_end_position,o="",e<=t.length?o=t.slice(this.state.search_start_position,e):this.state.search_start_position<=t.length&&(this.setState({search_end_position:t.length}),o=t.slice(this.state.search_start_position)),o.replace("@","")},_addMentionIntoInput:function(t,o){var n,a,l,c,u,p,d,h,m;return s.findDOMNode(this.refs.textInput),m=this._mentionWrapper(t.identifier,t.name,t.dbx_account_id),p=e(i.sanitize(m))[0],null!=r.webkit?p.setAttribute("contenteditable","false"):null!=r.mozilla&&p.setAttribute("style","margin-left:-3px; margin-right:-3px"),e(p).mousedown((function(t){return function(e){return t._onMentionMouseDown(e)}})(this)),null==o&&(u=this._extractCursorInfo(),c=u[0],u[1],u[2],o=document.createRange(),h=this.state.search_start_position,a=this.state.search_end_position,this.state.show_contacts||(this.setState({search_start_position:c.length}),this.setState({search_end_position:c.length}),h=c.length,a=c.length),this.isInNoAtMentionMode&&(h=this.currentCursorWordStartPosition,a=this.currentCursorWordEndPosition),o.setStart(c,h),o.setEnd(c,a)),p=this.unsafeInsertHtmlAtRange(p,o,!0),l=p.nextSibling,null!=l&&l.nodeType===Node.TEXT_NODE?(l.nodeValue=g+l.nodeValue,this._setCursorLocation(l,1)):(d=document.createTextNode(i.sanitize(g)),e(d).insertAfter(p),this._setCursorLocation(d,1)),"function"==typeof(n=this.props).onMention&&n.onMention(t),this.setState({show_contacts:!1})},focusInput:function(){var t,e;return this.setState({in_edit_mode:!0}),e=s.findDOMNode(this.refs.textInput),e.focus(),"function"==typeof(t=this.props).onEditModeChange?t.onEditModeChange(!0):void 0},disableMentions:function(){if(this.state.show_contacts)return this.setState({show_contacts:!1})},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(t){return"@[%(identifier)s:%(name)s]".format({identifier:t.identifier,name:t.name})},extractMentions:function(){var t,o,n,s,i,r,a,l;for(r=this.$text_input.find(".new-mention"),a=[],o=0,s=r.length;o<s;o++)i=r[o],n=e(i).data("id"),l=e(i).data("name"),t=e(i).data("dbx-account-id"),a.push(this.createMentionObject(n,l,t));return a},_encodeHtml:function(t){var o,n,s,i,r,a,l,c,u;if(s="",i=!1,t=t.replace(b,""),null!=t&&""!==t)for(c=e.parseHTML(t),r=0,a=c.length;r<a;r++)o=c[r],o.nodeType===Node.TEXT_NODE&&""!==o.nodeValue?(i=!0,s+=o.nodeValue):o instanceof HTMLParagraphElement?(i=!0,s=s+this._encodeHtml(e(o).html())+"\n"):e(o).hasClass("new-mention")?(i=!0,n=e(o).data(),l=this.createMentionObject(n.id,n.name),s+=this._encodedMention(l)):e(o).is("br")?s+="\n":e(o).is("div")?(u=e(o).text(),i=i||u.length>0,s=s+"\n"+u):(u=e(o).text(),i=i||u.length>0,s+=u);return s!==this.props.placeholder_text&&i?s=s.replace(/\s+$/,""):""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var t;return t=this.$text_input.html(),this._encodeHtml(t)},render:function(){var t,e,n,s,i,a,l,c;return e={"text-input":!0,"edit-mode":this.state.in_edit_mode},i=o(e),n=!0,null!=r.webkit&&(n="plaintext-only"),t={ref:"textInput","aria-label":this.props.placeholder_text,"aria-multiline":!0,className:i,contentEditable:n,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown,role:"textbox"},s=v.div({className:"mention-text-input-wrapper"},v.div({className:"placeholder-text","aria-hidden":!0},this.props.showPlaceholderText?this.props.placeholder_text:void 0),v.div(t)),c=m({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isDemoMode:this.props.isDemoMode}),a=o({"mentions-container":!0}),l=o({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput&&!this.props.shouldAlwaysInEditMode&&!this.props.shouldDisableHighlight}),v.div({className:a,ref:"container"},v.div({className:l,ref:"input"},s),c)}})})}.call(this),function(){define("modules/clean/react/activity/resolve_button",["external/classnames","external/react","modules/core/i18n","modules/core/notify","modules/clean/components/title_bubble","modules/clean/react/sprite","modules/clean/react/sprite_div","modules/constants/file_viewer"],function(t,e,o,n,s,i,r,a){var l,c;return l=o._,c=e.DOM,e.createClass({displayName:"ResolveButton",propTypes:{resolved:e.PropTypes.bool.isRequired,onUpdateResolve:e.PropTypes.func.isRequired,isOffline:e.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},_updateResolved:function(t){var e;return t.stopPropagation(),this.props.isOffline?(e=l(this.props.resolved?"Cannot unresolve comments while offline":"Cannot resolve comments while offline"),n.error(e)):this.props.onUpdateResolve(!this.props.resolved)},render:function(){var o,n;return o=l(this.props.resolved?"Unresolve":"Resolve"),n=t({"resolve-conversation-checkmark":!0,resolved:this.props.resolved}),e.createElement(s,{className:n,text:o,direction:"south"},c.button({className:"resolve-button","aria-pressed":this.props.resolved,onClick:this._updateResolved},c.div({className:"resolved-icon"},a.MAESTRO_ENABLED?this.props.resolved?e.createElement(r,{group:"web",name:"s_greychecked",alt:l("Unresolve"),text:l("Resolved"),spritePosition:"right"}):e.createElement(r,{group:"web",name:"s_greycheck",alt:l("Resolve"),text:l("Resolve"),spritePosition:"right"}):this.props.resolved?e.createElement(i,{group:"web",name:"s_greenchecked",alt:l("Unresolve")}):e.createElement(i,{group:"web",name:"s_greycheck",alt:l("Resolve")}))))}})})}.call(this),function(){define("modules/clean/react/activity/time_counter",["external/react","modules/clean/datetime"],function(t,e){var o;return o=t.DOM,t.createClass({displayName:"TimeCounter",render:function(){var t;return t=e.ago(new Date(this.props.when_mses)),o.div({className:"activity-time-ago"},t)},updateLoop:function(){},componentDidMount:function(){return this.updateLoop()},getUpdateInterval:function(){return 5e3}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify",["external/react","modules/clean/react_format","modules/clean/react/tooltip","modules/core/i18n"],function(t,e,o,n){var s,i,r,a;return a=e.reactFormat,i=n._,r=t.DOM,s=t.createFactory(o.Tooltip),t.createClass({displayName:"UsersToNotify",propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired,shouldPopupsDropdown:t.PropTypes.bool},render:function(){var t,e,n,l,c,u,p,d,h;return e=null==this.props.usersToNotify?[]:(this.props.user.is_signed_in,function(){var t,e,o,n;for(o=this.props.usersToNotify,n=[],t=0,e=o.length;t<e;t++)h=o[t],h.id!==this.props.user.id&&n.push(h);return n}.call(this)),n=e.length,n>0?(p=r.div({className:"notification-names-container"},function(){var t,o,n;for(n=[],t=0,o=e.length;t<o;t++)h=e[t],n.push((function(t){return function(t){return r.div({key:t.id},t.getDisplayIdentity())}})(this)(h));return n}.call(this)),t=r.span({className:"blue"}),c=1===n?a(i("<blueSpan>%(name)s</blueSpan> will be notified."),{name:e[0].getDisplayIdentity(),blueSpan:t}):2===n?a(i("<blueSpan>%(name)s and %(name2)s</blueSpan> will be notified."),{name:e[0].getDisplayIdentity(),name2:e[1].getDisplayIdentity(),blueSpan:t}):a(i("<blueSpan>%(name)s and %(num)s others</blueSpan> will be notified."),{name:e[0].getDisplayIdentity(),num:n-1,blueSpan:t}),l=r.div({className:"comment-box-text"},c),d=this.props.shouldPopupsDropdown?o.TooltipPosition.BOTTOM:o.TooltipPosition.TOP,n>2?s({position:d,tooltip_contents:p,tooltip_classname:"notification-names-tooltip"},l):l):(u=i("@Mention to notify someone."),r.div({className:"comment-box-text"},u))}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify_facepile",["external/react","modules/core/i18n","modules/clean/react/tooltip","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar"],function(t,e,o,n,s){var i,r,a,l;return e._,e.ungettext,r=o.Tooltip,a=o.TooltipPosition,l=t.DOM,i=6,t.createClass({propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired},render:function(){var e,o,c,u,p,d,h,m,_,f,g;for(c=function(){var t,e,o,n;for(o=this.props.usersToNotify,n=[],t=0,e=o.length;t<e;t++)g=o[t],n.push(g);return n}.call(this),e=[],_=[],u=(function(t){return function(t){return p<i?e.push(t):_.push(t)}})(this),p=d=0,h=c.length;d<h;p=++d)g=c[p],u(g);return l.div({className:"notify-facepile-container"},(function(){var i,c,u;for(u=[],i=0,c=e.length;i<c;i++)g=e[i],o=l.div({},g.display_name),u.push(l.div({className:"notify-facepile-photo",key:g.id},t.createElement(r,{
position:a.BOTTOM,tooltip_contents:o,tooltip_classname:"notification-names-tooltip"},t.createElement(s,{alt:g.display_name,dimension:32,photoUrl:g.photo_circle_url,defaultAvatar:t.createElement(n,{alt:g.display_name,dimension:32,shape:"CIRCLE",initials:g.initials}),key:g.id}))));return u})(),c.length>i?(f=l.div({},(function(){var t,e,o;for(o=[],t=0,e=_.length;t<e;t++)m=_[t],o.push(l.div({},m.get_display_identity()));return o})()),t.createElement(r,{position:a.BOTTOM,tooltip_contents:f,tooltip_classname:"notification-names-tooltip"},l.div({className:"notify-facepile-more"},"+"+(c.length-i)))):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_card",["external/react","modules/clean/activity/activity_user","modules/clean/react/activity/users_to_notify","modules/core/i18n"],function(t,e,o,n){var s,i,r;return s=e.ActivityUser,i=n._,r=t.DOM,t.createClass({displayName:"CommentCard",propTypes:{user:t.PropTypes.object,usersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(s)),shouldShowNotifyHint:t.PropTypes.bool,isOffline:t.PropTypes.bool,shouldPopupsDropdown:t.PropTypes.bool},renderNotifyHint:function(){return this.props.isOffline?r.div({className:"comment-box-text"},i("Posting will be re-enabled when you are online")):r.div({ref:"usersToNotify",className:"tooltip-container"},t.createElement(o,{usersToNotify:this.props.usersToNotify,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown}))},render:function(){return r.div({className:"comment-card-w-hint"},r.div({className:"comment-card"},this.props.children),this.props.shouldShowNotifyHint?this.renderNotifyHint():void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_header",["jquery","external/react","modules/core/i18n","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/users_to_notify_facepile","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger"],function(t,e,o,n,s,i,r){var a,l;return a=o._,l=e.DOM,e.createClass({displayName:"CommentListHeader",mixins:[e.addons.PureRenderMixin],propTypes:{activity:e.PropTypes.object,user:e.PropTypes.object,commentListOptions:e.PropTypes.node},_contactsSelectorPopupShown:function(){return setTimeout((function(e){return function(){return t(".contacts-selector-popup input").trigger("focus")}})(this),300)},render:function(){return l.div({className:"comment-list-header-container"},l.div({className:"comment-list-header"},l.div({className:"comment-list-header-inner"},l.span({className:"title"},a("Comments")),l.span({className:"options"}),this.props.commentListOptions)))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_options",["jquery","external/classnames","external/react","modules/core/i18n","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/sprite_div","modules/clean/comments/events","modules/clean/comments/utils","modules/constants/legacy"],function(t,e,o,n,s,i,r,a,l,c){var u,p,d,h,m;return h=n._,p=a.CommentsEvents,m=o.DOM,u=o.createFactory(s),d=o.createFactory(r),o.createClass({displayName:"CommentListOptions",mixins:[o.addons.PureRenderMixin],propTypes:{activity:o.PropTypes.object,show_resolved:o.PropTypes.bool.isRequired,num_resolved:o.PropTypes.number.isRequired,is_subscribed:o.PropTypes.bool.isRequired,feedback_off:o.PropTypes.bool.isRequired,activity_context:o.PropTypes.number.isRequired,shouldShowDisableButton:o.PropTypes.bool.isRequired,user:o.PropTypes.object,isOffline:o.PropTypes.bool,actionCreators:o.PropTypes.object.isRequired},getDefaultProps:function(){return{isOffline:!1,num_resolved:0}},_hide_comments:function(t){return this.refs.dropdown.hide(),null!=this.props.activity&&i.log_event(c.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_COMMENTS_HIDDEN,this.props.activity.activity_key,null,null,this.props.user.id,this.props.activity_context),this.props.actionCreators.hideComments(),p.emit("hide-comments-pane")},_toggle_show_resolved:function(){if(0!==this.props.num_resolved&&!this.props.feedback_off)return this.refs.dropdown.hide(),this.props.show_resolved?this.props.actionCreators.hideResolvedComments():this.props.actionCreators.showResolvedComments()},_isSubscribeDisabled:function(){return this.props.feedback_off||this.props.isOffline},_toggle_subscribe:function(){if(!this._isSubscribeDisabled())return this.refs.dropdown.hide(),this.props.actionCreators.setCommentSubscribed({subscribed:!this.props.is_subscribed})},_isFeedbackSettingDisabled:function(){return this.props.isOffline},_turn_off_feedback:function(){if(!this._isFeedbackSettingDisabled())return this.refs.dropdown.hide(),this.props.actionCreators.setCommentsEnabled({enabled:!1})},render:function(){var t,o,n,s,i,r,a,l,c,p;return n=[],r=h(this.props.show_resolved?"Hide resolved comments":"Show resolved comments"),s=e({"comments-header-menu-option":!0,"toggle-resolved":!0,disabled:0===this.props.num_resolved||this.props.feedback_off}),i=m.a({key:"resolved",className:s,onMouseUp:this._toggle_show_resolved},d({group:"web",name:"s_resolve",text:r})),n.push(i),this.props.is_subscribed?(p=h("Unsubscribe from notifications"),l="s_notifications_off"):(p=h("Subscribe to notifications"),l="s_notifications_on"),a=e({"comments-header-menu-option":!0,"toggle-subscribe":!0,disabled:this._isSubscribeDisabled()}),c=m.a({key:"subscribe",className:a,onMouseUp:this._toggle_subscribe},d({group:"web",name:l,text:p})),n.push(c),this.props.shouldShowDisableButton&&(t=e({"comments-header-menu-option":!0,"toggle-feedback-setting":!0,disabled:this._isFeedbackSettingDisabled()}),o=m.a({key:"toggle-feedback-setting",className:t,onMouseUp:this._turn_off_feedback},d({group:"web",name:"s_disable",text:h("Disable comments")})),n.push(o)),m.span({className:"options"},u({ref:"dropdown",targetButton:m.button({className:"button-as-link"},h("Options")),arrow_position:"top-right",vertical_displacement:8,extra_css_class:"comments-header-bubble-dropdown"},n))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_ui",["jquery","external/react","external/react-dom","external/underscore","external/classnames","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/annotations/annotation","modules/clean/components/loading_indicator","modules/clean/comments/events","modules/clean/comments/store","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/comment_list_options","modules/clean/react/file_comments/conversation_or_input_card","modules/clean/react/file_comments/file_revision_card","modules/clean/react/file_comments/comment_tutorial","modules/clean/react/image","modules/clean/react_format","modules/clean/react/sprite","modules/clean/static_urls","modules/clean/comments/collection_utils","modules/clean/comments/components/ui_constants","modules/constants/comments_panel","modules/constants/file_viewer"],function(t,e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,g,y,v,C,b,T,S,w){var N,E,P,I,A,x,k,M,D,O,R,L,U,B,H,F,V,q,z,K,j,W,G;return z=i._,G=i.ungettext,r.ActivityUser,a.Annotation,x=c.CommentsEvents,k=m.ConversationCard,R=m.InputCard,j=y.reactFormat,W=C.static_url,q=T.TUTORIAL_INITIATOR,V=T.TUTORIAL_CREATE_ANNOTATION,K=e.DOM,U=e.addons.CSSTransitionGroup,E=e.createFactory(p.button),P=e.createFactory(d),I=e.createFactory(h),A=e.createFactory(f),O=e.createFactory(g),U=e.createFactory(U),F=e.createFactory(v),B=300,H=500,".comments-holder",N=100,D=90,M=70,L=2,e.createClass({displayName:"CommentListUI",mixins:[e.addons.PureRenderMixin],propTypes:{context:e.PropTypes.number,activity:e.PropTypes.object,showLoadingSpinner:e.PropTypes.bool,contactSearchLogger:e.PropTypes.object,user:e.PropTypes.object,shouldInitiallyFocusInput:e.PropTypes.bool,showBottomBar:e.PropTypes.bool,showResolvedComments:e.PropTypes.bool,isCommentsMinimized:e.PropTypes.bool,isUserSubscribed:e.PropTypes.bool,shouldAutoLinkify:e.PropTypes.bool,enableImport:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,isOffline:e.PropTypes.bool,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,initialCommentsCount:e.PropTypes.number,shouldDisplayRegionCreationButton:e.PropTypes.bool,isRegionCreationEnabled:e.PropTypes.bool,showTutorial:e.PropTypes.bool,currentTutorialStep:e.PropTypes.string,isCommentsServerView:e.PropTypes.bool,revisions:e.PropTypes.array,actionCreators:e.PropTypes.object.isRequired,isDemoMode:e.PropTypes.bool},getInitialState:function(){return{shouldPopupsDropdown:!0,showBottomBar:!1,showNewCommentPill:!1,numFileLevelCommentsShown:0,uncollapsed:!1,commentListHeight:0,isDemoMode:!1}},getDefaultProps:function(){return{shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillUnmount:function(){return t(window).unbind("resize.bottom_bar")},componentDidMount:function(){return t(window).bind("resize.bottom_bar",this.checkScroll),this.checkScroll()},componentWillReceiveProps:function(t){var e,o;if(e=this.props.activity,o=t.activity,e!==o&&!this.isScrolledToBottom()&&null!=e&&null!=o&&n.some(o.comment_activities.slice(e.comment_activities.length),function(e){return e.comment.commenter.id!==t.user.id}))return this.setState({showNewCommentPill:!0})},componentWillUpdate:function(t){return this.shouldScrollToBottom=this.isScrolledToBottom()},componentDidUpdate:function(t,e){var o,n;if(this._isActivityFetchDone())return null==t.activity&&(null!=(o=this.props.activity)&&null!=(n=o.comment_activities)?n.length:void 0)>0&&this.animateScrollToBottom(H),this.shouldScrollToBottom&&this.scrollToBottom(),this.checkScroll(),this.updateListHeight()},onNewCommentPillClick:function(){return this.animateScrollToBottom(B),this.setState({showNewCommentPill:!1})},onAddReply:function(t,e){return this.props.actionCreators.addReply({targetActivityKey:e.activity_key,body:{text:t}})},onAddFileComment:function(t){return this.props.actionCreators.addFileComment({text:t})},onAddSticker:function(t){return this.props.actionCreators.addFileComment({stickerId:t})},isScrolledToBottom:function(){var e;if(!S.IS_COMBINED_COMMENTS_ENABLED)return e=t(o.findDOMNode(this.refs.commentList)),e[0].scrollHeight-e.scrollTop()-4<=e.outerHeight()},onCommentListClick:function(){x.emit("collapse-all-conversations")},onCommentExpanded:function(t,e){return this.scrollCommentIntoView(t,e),this.props.actionCreators.setExpandedComment(!0)},onScroll:function(){return this.checkScroll()},checkScroll:function(){var e,n;if(w.MAESTRO_ENABLED&&(e=t(o.findDOMNode(this.refs.commentList)),this.setState({scrollTop:e.scrollTop()})),!S.IS_COMBINED_COMMENTS_ENABLED)return n=this.isScrolledToBottom(),this.setState({showBottomBar:!n,showNewCommentPill:!n&&this.state.showNewCommentPill})},updateListHeight:function(){var e;if(null!=this.refs.commentList&&(e=t(o.findDOMNode(this.refs.commentList)).outerHeight(),this.state.commentListHeight!==e))return this.setState({commentListHeight:e})},turnOnFeedback:function(){return this.props.actionCreators.setCommentsEnabled({enabled:!0})},_isActivityFetchDone:function(){return null!=this.props.activity},forceBlur:function(){return t(document.activeElement).blur()},animateScrollToBottom:function(e){var n;if(null==e&&(e=600),!S.IS_COMBINED_COMMENTS_ENABLED)return n=o.findDOMNode(this.refs.commentList),t(n).animate({scrollTop:n.scrollHeight},{duration:e})},scrollToBottom:function(){var t;if(!S.IS_COMBINED_COMMENTS_ENABLED)return t=o.findDOMNode(this.refs.commentList),t.scrollTop=t.scrollHeight},scrollCommentIntoView:function(e,n){var s,i;if(s=o.findDOMNode(this.refs.commentList),i=e+n-s.offsetTop-t(s).outerHeight(),i>t(s).scrollTop())return t(s).animate({scrollTop:i},{duration:300})},animateScrollIntoView:function(e){var n,s,i,r,a;return i=e.node,r=null!=(a=e.padTop)?a:0,n=t(o.findDOMNode(this.refs.commentList)),s=t(i),n.animate({scrollTop:n.scrollTop()+s.offset().top-n.offset().top-r},{duration:500})},positionDropdownCallback:function(){var e,n,s,i;if(!S.IS_COMBINED_COMMENTS_ENABLED)return i=t(o.findDOMNode(this.refs.commentList)).outerHeight(),n=0,null!=this.refs.commentListHeader&&(n=t(o.findDOMNode(this.refs.commentListHeader)).outerHeight()),s=t(o.findDOMNode(this.refs.commentInputCard)).outerHeight(),e=i+n+s,this.setState({shouldPopupsDropdown:Boolean(i<e/2)})},renderLoadingSpinner:function(){return K.div({className:"comments-loading",key:"LoadingSpinner"},e.createElement(l,{style:l.LoadingIndicatorStyle.BLUE_SPINNER}),null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0?K.div({className:"comments-loading__count",ref:"commentsLoadingCount"},G("Loading %(count)s comment","Loading %(count)s comments",this.props.initialCommentsCount).format({count:this.props.initialCommentsCount})):void 0)},renderBlankState:function(){return this.props.isCommentsMinimized?null:this.props.showTutorial?this.renderTutorialBlankState():w.MAESTRO_ENABLED?this.renderMaestroDefaultBlankState():this.renderDefaultBlankState()},renderDefaultBlankState:function(){return K.div({className:"blank-state u-pad-horizontal-m u-pad-bottom-m",key:"DefaultBlankState"},K.div({className:"blank-state-illustration"},O({width:108,height:72,src:W("/static/images/commenting/comments_null_state-vflRF2RXk.png"),srcHiRes:W("/static/images/commenting/comments_null_state@2x-vflUmaRRX.png")})),K.div({className:"blank-state-text u-pad-vertical-xs"},j(z("Post a comment to start a discussion. <blue>@Mention</blue> someone to notify them."),{blue:K.span({key:"@MentionSpan",className:"blue"})})))},renderMaestroDefaultBlankState:function(){return K.div({className:"blank-state u-pad-horizontal-m u-pad-bottom-m",ref:"maestroBlankState",key:"DefaultBlankState"},K.div({className:"blank-state-illustration"},O({width:190,height:136,src:W("/static/images/commenting/comment-blank-vflZosqea.png"),srcHiRes:W("/static/images/commenting/comment-blank@2x-vfleV3tNK.png")})),K.div({className:"blank-state-text u-pad-vertical-xs"},j(z("Post a comment to start a discussion. <blue>@Mention</blue> someone to notify them."),{blue:K.span({key:"@MentionSpan",className:"blue"})})))},renderTutorialBlankState:function(){return K.div({key:"TutorialBlankState",ref:"tutorialBlankSlate",className:"blank-state u-pad-horizontal-m u-pad-bottom-m"},K.div({className:"blank-state-illustration"},O({width:140,height:105,src:W("/static/images/commenting/onboarding_step2-vflQHsmaO.png"),srcHiRes:W("/static/images/commenting/onboarding_step2@2x-vflEm4vmD.png")})),K.div({className:"blank-state-text blank-state-large-text blank-state-light-text u-pad-vertical-xs"},z("Comment on specific areas")),K.div({className:"blank-state-text blank-state-medium-text blank-state-light-text u-pad-vertical-xs"},z("See something that needs work? Leave a comment on the file.")),K.div({},E({className:"blank-state__button",importance:"primary",onClick:this.onTutorialBlankSlateClick},z("Show me how"))))},onTutorialBlankSlateClick:function(){this.props.actionCreators.setCurrentTutorialStep(V)},renderDisabledCommentState:function(){return K.div({className:"blank-state",key:"DisabledCommentsState"},K.div({className:"blank-state-icon"},F({group:"web",name:"s_comments_locked"})),K.div({className:"blank-state-text"},z("Comments are off for this file.")),K.div({className:"blank-state-button"},E({importance:"secondary",disabled:!this.props.activity.can_edit_feedback,onMouseUp:this.turnOnFeedback},z("Enable comments"))))},renderMaestroDisabledCommentState:function(){return K.div({className:"blank-state",key:"DisabledCommentsState"},K.div({className:"blank-state-text"},z("Comments are off for this file.")),K.div({className:"blank-state-button"},E({className:"c-btn c-btn--secondary",importance:"secondary",disabled:!this.props.activity.can_edit_feedback,onMouseUp:this.turnOnFeedback},z("Enable comments"))))},renderRevisionHistory:function(t){return K.div({className:"comment-card-w-hint comment-card-revision"},e.createElement(_,{fileRevisions:t}))},renderCommentCard:function(t,o){var s,i;return s={activity:this.props.activity,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,isOffline:this.props.isOffline,shouldShowPostText:w.MAESTRO_ENABLED},null!=t?e.createElement(k,{key:"threaded_"+t.activity_key,shouldInitiallyShowNotifyHint:!1,initialUsersToNotify:t.users_to_notify,commentProps:n.extend(s,this.getConversationSpecificProps(t,o)),actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}):!u.isCommentingEnabled()||this.props.isCommentsMinimized?null:e.createElement(R,{key:"FileLevelInputCard",ref:"commentInputCard",shouldInitiallyShowNotifyHint:!S.COMMENTS_COLLAPSE_INPUT&&!w.MAESTRO_ENABLED,initialUsersToNotify:null!=(i=this.props.activity)?i.users_to_notify:void 0,commentProps:n.extend(s,this.getInputSpecificProps()),actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode})},getInputSpecificProps:function(){return{shouldPopupsDropdown:this.state.shouldPopupsDropdown,showNewComment:this.state.showNewCommentPill,commentMetadataAllowed:S.ALLOW_STICKERS,shouldEnableStickers:S.ALLOW_STICKERS,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldAlwaysInEditMode:!1,shouldDisplayRegionCreationButton:this.props.shouldDisplayRegionCreationButton,isRegionCreationEnabled:this.props.isRegionCreationEnabled,isCommentInputDisabled:!this.props.activity,isCommentsServerView:this.props.isCommentsServerView,enableNoNotifyHint:!0,onAddComment:this.onAddFileComment,onAddSticker:this.onAddSticker,positionDropdownCallback:this.positionDropdownCallback,onShowNewComment:this.onNewCommentPillClick}},getConversationSpecificProps:function(t,e){return{commentActivity:t,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:e,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isCommentsServerView:this.props.isCommentsServerView,onAddComment:this.onAddReply,onCommentExpanded:this.onCommentExpanded,scrollIntoView:this.animateScrollIntoView}},renderCommentGroup:function(t,e){return K.div({className:"comment-list__group"},K.div({className:"time"},t),e)},renderAnnotationGroup:function(t,e){return K.div({className:"comment-list__group"},t?K.div({className:"time"},"Page "+t):void 0,e)},renderCommentList:function(t){return this._isActivityFetchDone()?this._isActivityFetchDone()&&this.props.activity.feedback_off?w.MAESTRO_ENABLED?this.renderMaestroDisabledCommentState():this.renderDisabledCommentState():t.length>0?t:this._isActivityFetchDone()?this.renderBlankState():void 0:this.props.showLoadingSpinner?this.renderLoadingSpinner():this.renderBlankState()},renderCommentListOptions:function(t){var e,o;return o=this._isActivityFetchDone()&&this.props.activity.feedback_off,e=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback,I({num_resolved:t,show_resolved:this.props.showResolvedComments,is_subscribed:this.props.isUserSubscribed,shouldShowDisableButton:!o&&e,feedback_off:o,activity_context:this.props.context,activity:this.props.activity,user:this.props.user,isOffline:this.props.isOffline,actionCreators:this.props.actionCreators})},renderTutorial:function(){return A({currentTutorialStep:this.props.currentTutorialStep,actionCreators:this.props.actionCreators})},hasComments:function(){return null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0||this._isActivityFetchDone()&&this.props.activity.comment_activities.length>0},_collapseComments:function(t,e,o,s){var i,r,a,l,c,u,p;for(l=n.findLastIndex(e,function(t){return t.shouldHighlightAsUnread()}),c=o,a=o*N,r=s*N,i=D+M+r,a+=i;c>L&&a>this.state.commentListHeight&&l<c-1;)c--,a=c*N,a+=i;return c<o&&(u=t.length-c,t=t.slice(0,c),p=K.a({className:"comments-collapse-toggle",onClick:(function(t){return function(){return t.setState({uncollapsed:!0})}})(this)},z("Show %(count)s more").format({count:u})),t.push(p)),t},render:function(){var t,e,o,n,i,r,a,l,c,u,p,d,h,m,_,f,g,y,v,C,T,N,E,I,A,x,k,M,D,O,R,L,U,B,H,F,V,z;if(m=[],a=[],R=0,O=0,D=0,this._isActivityFetchDone()){for(e=b.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:!0}),r={},T=N=0,A=e.length;N<A;T=++N)o=e[T],t=o.activity_key,r[t]=T+1;if(v=b.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!S.IS_COMBINED_COMMENTS_ENABLED||S.SHOW_REVISIONS,includeDocLevel:!0,includeResolved:this.props.showResolvedComments,sortBy:S.IS_COMBINED_COMMENTS_ENABLED&&!S.SHOW_REVISIONS?b.sortByReplyTime:void 0}),R=b.getNumResolved(this.props.activity.comment_activities),O=v.length,S.IS_COMBINED_COMMENTS_ENABLED)if(S.SHOW_REVISIONS)c=[],null!=this.props.revisions&&(c=v.concat(this.props.revisions)),c.sort(function(t,e){return b.sortByTimeOfCommentOrFileRevision(t,e)}),C=b.groupFileRevisions(c),u=v.concat(C),u.sort(function(t,e){return b.sortByTimeOfCommentOrFileRevisions(t,e)}),m=u.map((function(t){return function(e){return null!=e.comment?t.renderCommentCard(e,r[e.activity_key]):t.renderRevisionHistory(e)}})(this));else for(m=v.map(this.renderCommentCard),y=b.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:this.props.showResolvedComments,sortBy:b.sortByTime}),D=y.length,!this.state.uncollapsed&&O>0&&D>0&&(m=this._collapseComments(m,v,O,D)),F=b.groupAnnotationActivitiesByPage(y),L=F[0],n=F[1],I=0,k=L.length;I<k;I++)B=L[I],_=n[B].map((function(t){return function(e){return t.renderCommentCard(e,r[e.activity_key])}})(this)),a.push(this.renderAnnotationGroup(B,_));else for(H=b.groupCommentActivitiesByTime(v),U=H[0],l=H[1],E=0,x=U.length;E<x;E++)V=U[E],_=l[V].map((function(t){return function(e){return t.renderCommentCard(e,r[e.activity_key])}})(this)),m.push(this.renderCommentGroup(V,_))}return h=s({"comment-list":!0,"comment-list--minimized":this.props.isCommentsMinimized,scrolled:this.state.showBottomBar}),f=s({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder--border":w.MAESTRO_ENABLED&&this.state.scrollTop>0}),S.IS_COMBINED_COMMENTS_ENABLED?(p=this.renderCommentCard(),M=[],O>0&&(g=K.div({key:"FileLevelComments",className:"file-level-comments-list"},m),M.push(g)),O>0&&D>0&&M.push(K.hr({key:"HorizontalDivider",className:"c-rule u-mar-vertical-xs",style:{width:"100%"}})),D>0&&(i=K.div({key:"AnnotationCommentsList",className:"annotation-comments-list"},a),M.push(i)),d=[p,this.renderCommentList(M)]):d=this.renderCommentList(m),z=s({"comment-tutorial":!0,"comment-tutorial--is-dev":S.ARE_DEV_TOOLS_SHOWN}),K.div({className:f,ref:"commentsHolder"},this.props.isCommentsServerView?P({ref:"commentListHeader",activity:this.props.activity,user:this.props.user,commentListOptions:this.renderCommentListOptions(R)}):void 0,K.div({className:h,ref:"commentList",onScroll:this.onScroll,onClick:this.onCommentListClick},d),S.IS_COMBINED_COMMENTS_ENABLED?void 0:K.div({className:"legacy-file-comment-input",ref:"commentInputCard"},this.renderCommentCard()),!this.props.showTutorial||this.props.isCommentsMinimized||!this.hasComments()&&this.props.currentTutorialStep===q?void 0:K.div({className:z},this.renderTutorial()))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_tutorial",["external/react","external/classnames","modules/core/i18n","modules/clean/comments/constants","modules/clean/comments/store","modules/clean/comments/flux","modules/clean/comments/components/ui_constants","modules/clean/comments/logging","modules/clean/react/button","modules/clean/react/sprite","modules/clean/react_format","modules/clean/react/image","modules/clean/static_urls","modules/clean/css"],function(t,e,o,n,s,i,r,a,l,c,u,p,d,h){var m,_,f,g,y,v,C,b,T,S,w,N,E,P,I,A,x;return E=o._,f=n.FileActivityLogEventType,_=n.FileActivityLogClientOriginType,b=r.TUTORIAL_INITIATOR,w=r.TUTORIAL_REPLY,N=r.TUTORIAL_REPLY_SUCCESS,T=r.TUTORIAL_MENTION,S=r.TUTORIAL_MENTION_SUCCESS,v=r.TUTORIAL_CREATE_ANNOTATION,C=r.TUTORIAL_CREATE_ANNOTATION_SUCCESS,A=u.reactFormat,x=d.static_url,I=t.DOM,P=t.createElement,m=t.createFactory(l.button),y=t.createFactory(c),g=t.createFactory(p),t.createClass({displayName:"CommentTutorial",propTypes:{currentTutorialStep:t.PropTypes.string,actionCreators:t.PropTypes.object.isRequired},getDefaultProps:function(){return{currentTutorialStep:b}},componentDidMount:function(){return h.require_css("/static/css/sprites/emoji_sprites-vflJeUmZ7.css")},_logTutorial:function(t){return a.logEvent(t,_.COMMENTS_TUTORIAL)},_onShowMeHow:function(){return this.props.actionCreators.setCurrentTutorialStep(v)},_onClose:function(){return this._logTutorial(f.TUTORIAL_CLOSE),this.props.actionCreators.markCommentsTutorialAsDone(),this.props.actionCreators.setShowTutorial(!1)},_onDone:function(){return this._logTutorial(f.TUTORIAL_DONE),this.props.actionCreators.setShowTutorial(!1)},_onNext:function(){var t;return this._logTutorial(f.TUTORIAL_NEXT),this.props.currentTutorialStep===T?this.props.actionCreators.setShowTutorial(!1):(t=function(){switch(this.props.currentTutorialStep){case v:return w;case C:return w;case w:return T;case N:return T}}.call(this),this.props.actionCreators.setCurrentTutorialStep(t))},_renderCurrentStep:function(){switch(this.props.currentTutorialStep){case v:return this._logTutorial(f.TUTORIAL_CREATE_ANNOTATION),this._renderCreateAnnotationStep();case C:return this._logTutorial(f.TUTORIAL_CREATE_ANNOTATION_SUCCESS),this._renderCreateAnnotationSuccessStep();case w:return this._logTutorial(f.TUTORIAL_REPLY),this._renderReplyStep();case N:return this._logTutorial(f.TUTORIAL_REPLY_SUCCESS),this._renderReplySuccessStep();case T:return this._logTutorial(f.TUTORIAL_MENTION),this.props.actionCreators.markCommentsTutorialAsDone(),this._renderMentionStep();case S:return this._logTutorial(f.TUTORIAL_MENTION_SUCCESS),this._renderMentionSuccessStep();default:return this._renderInitiatorStep()}},_renderInitiatorStep:function(){return I.div({className:"comment-tutorial__step"},I.div({className:"comment-tutorial__text"},I.p({className:"comment-tutorial__text comment-tutorial__text--bold"},E("Comment on specific areas")),I.p({},E("See something that needs work? Leave a comment on the file."))),m({className:"comment-tutorial__button",importance:"secondary",onClick:this._onShowMeHow},E("Show me how")))},_renderCreateAnnotationStep:function(){return I.div({className:"comment-tutorial__step"},I.div({className:"comment-tutorial__text"},A(E("First, click the comment <CommentSprite/> button up above, then click anywhere on the file."),{CommentSprite:P(c,{group:"web",name:"ic_comment_area_dark",className:"comment-tutorial__sprite"})})),g({width:250,height:150,src:x("/static/images/commenting/onboarding_animation_step1-vflStlhr4.gif"),srcHiRes:x("/static/images/commenting/onboarding_animation_step1@2x-vfls5nQtW.gif")}))},_renderCreateAnnotationSuccessStep:function(){return I.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),I.div({className:"comment-tutorial__text"},I.p({className:"comment-tutorial__text comment-tutorial__text--bold"},E("Sweet!")),I.p({},E("Comments are an easy way to leave notes for others."))))},_renderReplyStep:function(){return I.div({className:"comment-tutorial__step"},I.div({className:"comment-tutorial__text"},E("Click any comment to review or reply to it.")),g({width:250,height:150,src:x("/static/images/commenting/onboarding_animation_step2-vfl96uLLF.gif"),srcHiRes:x("/static/images/commenting/onboarding_animation_step2@2x-vfl8g0EZh.gif")}))},_renderReplySuccessStep:function(){return I.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),I.div({className:"comment-tutorial__text"},I.p({className:"comment-tutorial__text comment-tutorial__text--bold"},E("Just like that!")),I.p({},A(E("You can even reply with emojis <Emoji/>"),{Emoji:P(c,{group:"emoji",name:"1F604",className:"comment-tutorial__sprite"})}))))},_renderMentionStep:function(){return I.div({className:"comment-tutorial__step"},I.div({className:"comment-tutorial__text"},E("To notify someone, create a comment and type “@” followed by their email address.")),g({width:250,height:150,src:x("/static/images/commenting/onboarding_animation_step3-vfl2mhKA1.gif"),srcHiRes:x("/static/images/commenting/onboarding_animation_step3@2x-vflJYSw1X.gif")}))},_renderMentionSuccessStep:function(){return I.div({className:"comment-tutorial__step"},this._renderSuccessIcon(),I.div({className:"comment-tutorial__text"},I.p({className:"comment-tutorial__text comment-tutorial__text--bold"},E("You’re a natural!")),I.p({},E("@mentions lets you notify others without having to send out a separate email."))))},_renderSuccessIcon:function(){return g({width:38,height:40,src:x("/static/images/commenting/tutorial_success-vflO6ncSG.png"),srcHiRes:x("/static/images/commenting/tutorial_success@2x-vflchqv1n.png")})},_getCurrentStepText:function(){switch(this.props.currentTutorialStep){case v:return E("Step 1/3");case C:return E("Step 1/3");case w:return E("Step 2/3");case N:return E("Step 2/3");case T:return E("Step 3/3");case S:return E("Step 3/3")}},_renderHeader:function(){return I.div({className:"comment-tutorial__toolbar clearfix"},I.div({className:"comment-tutorial__counter"},this._getCurrentStepText()),I.a({className:"comment-tutorial__close",onClick:this._onClose},y({alt:E("Close"),group:"web",name:"tutorial_close"})))},_renderFooter:function(){if(null!=this.props.currentTutorialStep&&this.props.currentTutorialStep!==b)return I.div({className:"comment-tutorial__footer clearfix"},this.props.currentTutorialStep===S?I.a({ref:"done",className:"comment-tutorial__done",onClick:this._onDone},E("Done")):I.a({ref:"next",className:"comment-tutorial__next",onClick:this._onNext},E("Next")))},render:function(){var t,o;return t={"comment-tutorial__steps":!0},t["comment-tutorial__steps-"+this.props.currentTutorialStep]=!0,o=t,I.div({className:"comment-tutorial__container"},this._renderHeader(),I.div({className:e(o),ref:this.props.currentTutorialStep},this._renderCurrentStep()),this._renderFooter())}})})}.call(this),function(){define("modules/clean/react/file_comments/conversation_or_input_card",["external/react","external/underscore","modules/clean/activity/activity_user","modules/clean/react/activity/comment_input","modules/clean/react/file_comments/comment_card","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/constants/comments_panel"],function(t,e,o,n,s,i,r){var a,l,c,u,p;return a=o.ActivityUser,p=function(t,o){var n,s,i;return n=e.indexBy(t,"id"),s=e.indexBy(o,"id"),i=e.extend({},n,s),e.values(i)},u={getInitialState:function(){return{mentionedUsers:[],shouldShowNotifyHint:this.props.shouldInitiallyShowNotifyHint}},getDefaultProps:function(){return{initialUsersToNotify:[]}},onMentionedUsersChanged:function(t){return this.setState({mentionedUsers:t})},getUsersToNotify:function(){return p(this.props.initialUsersToNotify,this.state.mentionedUsers)},clearMentionedUsers:function(){if(this.isMounted())return this.setState({mentionedUsers:[]})},setShouldShowNotifyHint:function(t){return this.setState({shouldShowNotifyHint:t})}},l=t.createClass({displayName:"ConversationCard",mixins:[t.addons.PureRenderMixin,u],propTypes:{shouldInitiallyShowNotifyHint:t.PropTypes.bool,initialUsersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(a)),commentProps:n.propTypes,actionCreators:t.PropTypes.object.isRequired,isDemoMode:t.PropTypes.bool},onAddComment:function(t,e){var o;return this.clearMentionedUsers(),"function"==typeof(o=this.props.commentProps).onAddComment?o.onAddComment(t,e):void 0},renderCommentThread:function(){return t.createElement(i,e.extend({},this.props.commentProps,{onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,
usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}))},render:function(){return t.createElement(s,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),shouldPopupsDropdown:!1},this.renderCommentThread())}}),c=t.createClass({displayName:"InputCard",mixins:[t.addons.PureRenderMixin,u],propTypes:{shouldInitiallyShowNotifyHint:t.PropTypes.bool,initialUsersToNotify:t.PropTypes.arrayOf(t.PropTypes.instanceOf(a)),commentProps:n.propTypes,actionCreators:t.PropTypes.object.isRequired,isDemoMode:t.PropTypes.bool},onAddComment:function(t){var e;return this.clearMentionedUsers(),"function"==typeof(e=this.props.commentProps).onAddComment?e.onAddComment(t):void 0},onEditModeChange:function(t){return this.setState({shouldShowNotifyHint:t})},renderCommentInput:function(){return t.createElement(n,e.extend({},this.props.commentProps,{ref:"commentInput",onMentionedUsersChanged:this.onMentionedUsersChanged,setShouldShowNotifyHint:this.setShouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),onAddComment:this.onAddComment,actionCreators:this.props.actionCreators,isCommentInputDisabled:this.props.commentProps.isCommentInputDisabled,isDemoMode:this.props.isDemoMode,onEditModeChange:this.onEditModeChange}))},render:function(){return t.createElement(s,{shouldInitiallyShowNotifyHint:this.props.shouldInitiallyShowNotifyHint,initialUsersToNotify:this.props.initialUsersToNotify,user:this.props.commentProps.user,isOffline:this.props.commentProps.isOffline,shouldShowNotifyHint:this.state.shouldShowNotifyHint,usersToNotify:this.getUsersToNotify(),shouldPopupsDropdown:r.IS_COMBINED_COMMENTS_ENABLED},this.renderCommentInput())}}),{ConversationCard:l,InputCard:c}})}.call(this),function(){define("modules/clean/react/file_comments/file_comments_pane",["jquery","external/underscore","external/classnames","external/react","modules/constants/comments_panel","modules/core/i18n","modules/core/notify","modules/clean/analytics","modules/clean/file_activity/api","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/toggle_bar","modules/clean/react/file_viewer/actions","modules/clean/comments/events","modules/clean/comments/utils","modules/clean/comments/store","modules/clean/file_activity/models/file_activity"],function(t,e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,g,y){var v,C,b,T,S,w,N,E,P,I,A,x,k;return x=i._,T=a.ContactSearchLogger,A=c.SimpleModal,P=c.Modal,E=h.FileCommentsToggleBar,b=_.CommentsEvents,S=y.FileActivity,k=n.DOM,v=n.createFactory(p),n.createFactory(u),C=n.createFactory(d),N=n.createFactory(E),I=1e3,w=n.createClass({displayName:"FileCommentsPane",mixins:[n.addons.PureRenderMixin],propTypes:{showButtonColor:n.PropTypes.string.isRequired,activity:n.PropTypes.instanceOf(S),context:n.PropTypes.number,contextData:n.PropTypes.string,showResolvedComments:n.PropTypes.bool,isPreviewReady:n.PropTypes.bool,showLoadingSpinner:n.PropTypes.bool,isCommentsHidden:n.PropTypes.bool,feedbackId:n.PropTypes.string.isRequired,userId:n.PropTypes.number,showDisabledCommentBar:n.PropTypes.bool,previewSelector:n.PropTypes.string,shouldInitiallyFocusInput:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,enableImport:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,oref:n.PropTypes.string,shouldCheckOffline:n.PropTypes.bool,shouldShowOnboarding:n.PropTypes.bool,onOnboardingModalOpen:n.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:n.PropTypes.bool,initialCommentsCount:n.PropTypes.number,isUserSubscribed:n.PropTypes.bool,isRegionCreationEnabled:n.PropTypes.bool,showTutorial:n.PropTypes.bool,currentTutorialStep:n.PropTypes.string,isCommentsServerView:n.PropTypes.bool,revisions:n.PropTypes.array,actionCreators:n.PropTypes.object.isRequired,isDemoMode:n.PropTypes.bool,isCommentingEnabled:n.PropTypes.bool,showToggleButton:n.PropTypes.bool},getInitialState:function(){return{icon:"s_comments_locked",isOffline:!1,height:0}},getDefaultProps:function(){return{shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,file:null,shouldCheckOffline:!1,shouldShowOnboarding:!1,isDemoMode:!1,shouldAnnotationButtonUseThumbnailUrls:s.ALLOW_ANNOTATION_THUMBNAILS}},componentWillMount:function(){return this.isAnnotationGhostEnabled=s.ALLOW_ANNOTATION_GHOST},componentDidMount:function(){if(this._refreshWidth(),this.contactSearchLogger=new T,this.props.shouldCheckOffline)return this._checkAndSetIsOffline(),this.offlineInterval=setInterval(this._checkAndSetIsOffline,I)},maybeShowOnboardingModal:function(){var t;if(this.props.shouldShowOnboarding)return t=C({onOpen:this.props.onOnboardingModalOpen}),P.showInstance(t)},fitToHeight:function(t){if(this.state.height!==t)return this.setState({height:t})},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this._getActivity()&&this.previewIsReady&&!this.state.isFetchingActivity},_fileHasReplies:function(){var t,e,o,n;if(null!=this._getActivity())for(n=this._getActivity().comment_activities,e=0,o=n.length;e<o;e++)if(t=n[e],t.comment_activities.length>0)return!0;return!1},_checkAndSetIsOffline:function(){return this.setState({isOffline:!navigator.onLine})},_getActivity:function(){return this.props.activity},_showResolvedComments:function(){return this.props.showResolvedComments},showFeedbackModal:function(e){var o;return null!=e&&e.preventDefault(),o='<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Let us know how we can improve commenting in Dropbox." ></textarea> </div> </div>',A.show({title_text:x("Help us improve comments"),body_html:o,cancel_text:x("Cancel"),confirm_text:x("Submit Feedback"),confirm_callback:(function(e){return function(){var o,n,s;return o=t("#comments-feedback-input").val(),s=function(){return r.success(x("Thank you! Your feedback will help improve Dropbox."))},n=function(){return function(){return r.error(x("There was an error submitting your feedback."))}},l.submitProductFeedback({actorId:e.props.userId,feedbackText:o,context:e.props.context,contextData:e.props.contextData,oref:e.props.oref}).then(s,n)}})(this)})},getActivityUser:function(){return f.getActivityUser(this.props.userId)},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},show:function(){return this.props.actionCreators.showComments(),b.emit("show-comments-pane")},_refreshWidth:function(){if(t(".video-js").length)return t(".video-js").css("width","100%")},_isMinimized:function(){return this.props.showToggleButton&&this.props.isCommentsHidden},_renderCommentsListUI:function(){var t,e,o;return o=this.getActivityUser(),e=o.is_signed_in&&s.ALLOW_WEB_FEEDBACK&&!this.props.isDemoMode&&!this.props.isCommentsServerView,t=s.ALLOW_VIEW_ANNOTATE_MODES&&this.props.isPreviewReady,k.div({className:"comments-and-feedback"},this.state.isOffline?k.div({className:"comments-offline-banner"},k.div({className:"comments-offline-banner-inner"},x("No Internet Connection"))):void 0,v({ref:"commentListUI",showLoadingSpinner:this.props.showLoadingSpinner,context:this.props.context,activity:this._getActivity(),user:o,contactSearchLogger:this.contactSearchLogger,initialCommentsCount:this.props.initialCommentsCount,revisions:this.props.revisions,isCommentsMinimized:this._isMinimized(),isUserSubscribed:this.props.isUserSubscribed,shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showResolvedComments:this._showResolvedComments(),enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isOffline:this.state.isOffline,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldDisplayRegionCreationButton:t,isRegionCreationEnabled:this.props.isRegionCreationEnabled,showTutorial:this.props.showTutorial&&this.props.isPreviewReady,currentTutorialStep:this.props.currentTutorialStep,isCommentsServerView:this.props.isCommentsServerView,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode}),e&&!this._isMinimized()?k.div({className:"comments-feedback-link"},k.div({className:"comments-feedback-link-inner"},k.a({onMouseUp:this.showFeedbackModal},x("Help us improve comments")))):void 0)},render:function(){var t,e,n,s;return t=o({"file-feedback":!0,"file-feedback--border":this.props.showToggleButton,"file-feedback--minimized":this._isMinimized(),"preview-ready":this.props.isPreviewReady,hidden:!this.state.enabled}),n=0!==this.state.height?{height:this.state.height}:{},e={id:this.props.feedbackId,ref:"fileCommentsPane",className:t,tabIndex:"-1",style:n},this.props.showToggleButton?(s=N({isHidden:this.props.isCommentsHidden,actionCreators:this.props.actionCreators}),k.div(e,s,this._renderCommentsListUI())):this.props.isCommentsHidden?k.div({id:this.props.feedbackId,className:"hidden"}):k.div(e,this._renderCommentsListUI())}}),{FileCommentsPaneClass:w}})}.call(this),function(){define("modules/clean/react/file_comments/file_revision_card",["external/react","modules/core/i18n","modules/clean/react_format","modules/clean/datetime","modules/clean/react/sprite"],function(t,e,o,n,s){var i,r,a,l;return l=e.ungettext,a=o.reactFormat,i=n.ago,r=t.DOM,t.createClass({displayName:"FileRevisionCard",propTypes:{fileRevisions:t.PropTypes.array.isRequired},getInitialState:function(){return{collapsed:!1}},_onClick:function(){return this.setState({collapsed:!this.state.collapsed})},_renderHeader:function(){var e,o,n,i,c,u;for(o=this.props.fileRevisions[0],e=[],u=this.props.fileRevisions,i=0,c=u.length;i<c;i++)n=u[i],e.indexOf(n.author)<0&&e.push(n.author);return r.div({},r.div({className:"comment-revision-history__icon"},t.createElement(s,{group:"web",name:"previous_versions"})),r.div({className:"comment-revision-history__header"},o.is_primary_revision?o.action_description:a(l("<a>%(count)s revision</a> updated by %(authors)s","<a>%(count)s revisions</a> updated by %(authors)s",this.props.fileRevisions.length),{a:r.a(),count:this.props.fileRevisions.length,authors:e.length>2?e.join(", "):e.join(" and ")})))},_renderRevisions:function(){var t;return r.ul({className:"comment-revision-history__list"},function(){var e,o,n,s;for(n=this.props.fileRevisions,s=[],e=0,o=n.length;e<o;e++)t=n[e],s.push(r.li({},a("<spanSize>"+t.file.size+"</spanSize> <b>"+t.author+"</b> <spanDetails> "+i(t.when_mses)+" ("+t.device_name+")</spanDetails>",{spanSize:r.span({className:"comment-revision-history__size"}),b:r.b(),spanDetails:r.span({className:"comment-revision-history__details"})})));return s}.call(this))},render:function(){return r.div({className:"comment-revision-history",onClick:this._onClick},this._renderHeader(),this.state.collapsed?this._renderRevisions():void 0)}})})}.call(this),define("modules/clean/react/file_comments/live_sticker",["require","exports","tslib","external/react","external/react-dom","external/classnames","modules/clean/react/pure_render","modules/clean/sticker_util","modules/clean/event_handler","modules/clean/comments/lib/animation"],function(t,e,o,n,s,i,r,a,l,c){"use strict";var u=(function(t){function e(e){var o=t.call(this,e)||this;return o.onPreviewLoad=function(){o.setState({previewReady:!0,initial:!o.props.skipInitial&&o.state.spritesReady})},o.onStaticLoad=function(){o.setState({staticReady:!0})},o.onSpritesLoad=function(){o.setState({spritesReady:!0,initial:!o.props.skipInitial&&o.state.previewReady})},o.state={previewReady:!1,staticReady:!1,spritesReady:!1,mouseOver:!1,initial:!1,intro:!1,loop:!1,outro:!1},o}return o.__extends(e,t),e.prototype.componentDidMount=function(){var t=s.findDOMNode(this.refs.sticker);this.events.on(t,c.ANIMATION_ITERATION_EVENT,this.onAnimationIteration,this),this.events.on(t,c.ANIMATION_END_EVENT,this.onAnimationEnd,this),this.events.on(t,"mouseenter touchstart",this.onMouseEnter,this),this.events.on(t,"mouseleave touchend",this.onMouseLeave,this)},e.prototype.onAnimationIteration=function(){this.setState({initial:this.state.initial&&!this.state.mouseOver,intro:this.state.loop&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},e.prototype.onAnimationEnd=function(){this.setState({initial:!1,intro:this.state.outro&&!this.state.mouseOver,loop:this.state.mouseOver,outro:!1})},e.prototype.onMouseEnter=function(){this.state.mouseOver||this.setState({mouseOver:!0,outro:!(this.state.loop||this.state.intro||this.state.initial)})},e.prototype.onMouseLeave=function(){this.state.mouseOver&&this.setState({mouseOver:!1})},e.prototype.render=function(){var t=this.props,e=t.stickerId,o=t.size,s=this.state,r=s.previewReady,l=s.spritesReady,c=s.initial,u=s.intro,p=s.loop,d=s.outro,h="live-sticker-"+e,m=null,_=i("live-sticker","live-sticker-"+e,{"live-sticker-ready":r&&l,"live-sticker-initial":c,"live-sticker-intro":u,"live-sticker-loop":p,"live-sticker-outro":d,"live-sticker-size-small":"small"===o});return r&&l||(m=n.createElement("img",{className:"live-sticker-preview",onLoad:this.onPreviewLoad,src:a.getStickerImageUrl(e,"preview"),alt:h})),n.createElement("span",{ref:"sticker",className:_,"data-sticker-id":e},n.createElement("img",{className:"live-sticker-sprites",onLoad:this.onSpritesLoad,src:a.getStickerImageUrl(e,"sprites"),alt:""}),n.createElement("span",{className:"live-sticker-sprites-overlay"}),n.createElement("img",{className:"live-sticker-static",onLoad:this.onStaticLoad,src:a.getStickerImageUrl(e,"png"),srcSet:a.getStickerImageUrl(e,"png@2x")+" 2x",alt:h}),m)},e})(n.Component);u=o.__decorate([r.pureRender,l.eventHandler],u),e.LiveSticker=u}),function(){define("modules/clean/react/file_comments/standalone_feedback_ui",["external/react","modules/constants/comments_panel","modules/clean/activity/constants","modules/clean/history","modules/clean/react/file_comments/file_comments_pane","modules/clean/server_side_client_view_bridge","modules/clean/web_timing_logger","modules/clean/comments/action_creators","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/clients/file_activity_data_source"],function(t,e,o,n,s,i,r,a,l,c,u,p){var d,h,m,_;return d=o.ActivityContext,m=s.FileCommentsPaneClass,t.DOM,h=t.createFactory(m),_=t.createClass({displayName:"StandaloneFeedbackUI",mixins:[l.sync(c)],propTypes:{"fq-path":t.PropTypes.string.isRequired},componentWillMount:function(){var t,o;if(p.initInstance(),n.update_query_param("oref","sscv"),t=u.getActivityUser().id,o=this.props["fq-path"],a.startViewingComments({actorId:t,context:d.BROWSE_FILE_VIEWER,contextData:o,oref:"sscv",file:null,previewSelector:null}),e.SHOW_REVISIONS)return a.fetchRevisions(o)},componentDidMount:function(){return this.refs.fileCommentsPane.fitToHeight(window.innerHeight)},componentDidUpdate:function(t,e){if(null==e.activity&&null!=this.state.activity)return this.onActivityLoaded()},onActivityLoaded:function(t){if(!this.marked_tti)return this.marked_tti=!0,r.mark_time_to_interactive()},render:function(){return h({ref:"fileCommentsPane",feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,revisions:this.state.revisions,userId:this.state.actorId,file:null,oref:this.state.oref,showResolvedComments:this.state.showResolvedComments,enableImport:!1,shouldAutoLinkify:!0,shouldCheckOffline:!1,shouldHidePhotoAvatars:!1,shouldUseSimpleModals:!0,shouldAnnotationButtonUseThumbnailUrls:e.ALLOW_ANNOTATION_THUMBNAILS_SERVER_VIEW,showButtonColor:"white",visible:!0,isUserSubscribed:c.isUserSubscribed(this.state.actorId),isCommentsServerView:!0,actionCreators:a})}}),{StandaloneFeedbackUI:_}})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_activity_ui",["jquery","external/classnames","external/react","external/react-dom","external/underscore","modules/core/i18n","modules/clean/components/loading_indicator","modules/clean/datetime","modules/clean/event_handler","modules/clean/react/button","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/react/activity/resolve_button","modules/clean/comments/events","modules/clean/comments/lib/animation","modules/clean/comments/models/comment_activity","modules/clean/file_activity/models/file_activity","modules/constants/comments_panel","modules/constants/file_viewer"],function(t,e,o,n,s,i,r,a,l,c,u,p,d,h,m,_,f,g,y,v){var C,b,T,S,w,N,E,P,I,A,x;return x=i.ungettext,N=l.EventHandlerMixin,w=m.CommentsEventsMixin,C=_.ANIMATION_END_EVENT,b=f.CommentActivity,E=g.FileActivity,A=o.DOM,T=o.createFactory(p),S=o.createFactory(d),I=o.createFactory(h),P=47,o.createClass({displayName:"ThreadedCommentActivityUI",mixins:[o.addons.PureRenderMixin,N,w],propTypes:{context:o.PropTypes.number,commentActivity:o.PropTypes.instanceOf(b).isRequired,user:o.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:o.PropTypes.bool,shouldAutoLinkify:o.PropTypes.bool,shouldUseSimpleModals:o.PropTypes.bool,shouldHidePhotoAvatars:o.PropTypes.bool,activity:o.PropTypes.instanceOf(E).isRequired,replyText:o.PropTypes.string,showResolvedComments:o.PropTypes.bool,contactSearchLogger:o.PropTypes.object,onReplyInputFocus:o.PropTypes.func,onReplyInputBlur:o.PropTypes.func,enableImport:o.PropTypes.bool,showNewComment:o.PropTypes.bool,checkScroll:o.PropTypes.func,onShowNewComment:o.PropTypes.func,onCommentExpanded:o.PropTypes.func,onCancelComment:o.PropTypes.func,annotationNumber:o.PropTypes.number,isInAnnotationBubble:o.PropTypes.bool,scrollIntoView:o.PropTypes.func,setShouldShowNotifyHint:o.PropTypes.func,onMentionedUsersChanged:o.PropTypes.func,onAddComment:o.PropTypes.func,onInputChange:o.PropTypes.func,isCommentsServerView:o.PropTypes.bool,actionCreators:o.PropTypes.object.isRequired,isDemoMode:o.PropTypes.bool},getInitialState:function(){return{isExpanded:!1,isExpandedByReply:!1,highlighting:!1}},getDefaultProps:function(){return{shouldAnnotationButtonUseThumbnailUrls:!1,isDemoMode:!1}},componentDidMount:function(){if(!this.props.isInAnnotationBubble)return this.events.on(n.findDOMNode(this),C,this.onAnimationEnd,this),this.onCommentsEvent("reveal-comment-in-pane",this.onRevealComment),this.onCommentsEvent("collapse-all-conversations",this.onCollapseConversation)},componentDidUpdate:function(t,e){var o,s,i;if(this.state.isExpanded&&!e.isExpanded&&null!=this.props.onCommentExpanded&&(i=n.findDOMNode(this).offsetTop,s=n.findDOMNode(this).clientHeight+P,v.MAESTRO_ENABLED?this.state.isExpandedByReply&&!e.isExpandedByReply&&this.props.onCommentExpanded(i,s):this.props.onCommentExpanded(i,s),this.props.actionCreators.setExpandedComment(!0)),this.state.isExpanded!==e.isExpanded)return"function"==typeof(o=this.props).setShouldShowNotifyHint?o.setShouldShowNotifyHint(this.state.isExpanded):void 0},onRevealComment:function(t){var e,o,n;return e=t.activityKey,n=t.expandConversation,o=this.props.commentActivity,o.activity_key===e?this.revealConversation(n):s.findWhere(o.comment_activities,{activity_key:e})?this.revealReply(e,n):void 0},revealConversation:function(t){var e,o;return o={highlighting:!0},t&&(o.isExpanded=!0),this.setState(o),"function"==typeof(e=this.props).scrollIntoView?e.scrollIntoView({node:n.findDOMNode(this),padTop:10}):void 0},revealReply:function(t,e){return this.setState({isExpanded:!0},(function(e){return function(){var o;if(e.isMounted())return o=e.refs["child-"+t],null!=o?o.reveal():void 0}})(this))},onAnimationEnd:function(){return this.setState({highlighting:!1})},onCollapseConversation:function(){return this.setState({isExpanded:!1})},onAddComment:function(t){var e;return"function"==typeof(e=this.props).onAddComment?e.onAddComment(t,this.props.commentActivity):void 0},onAddSticker:function(t){return this.props.actionCreators.addReply({targetActivityKey:this.props.commentActivity.activity_key,body:{stickerId:t}})},resizeCallback:function(t){var e,o;if(null==t&&(t=!1),this.forceUpdate(),t&&null!=this.props.onCommentExpanded)return o=n.findDOMNode(this).offsetTop,e=n.findDOMNode(this).clientHeight+P,this.props.onCommentExpanded(o,e)},onClick:function(e){if(e.stopPropagation(),v.MAESTRO_ENABLED&&this.setState({isExpandedByReply:t(e.target).is("a.reply-button")}),this.state.isExpanded){if(this._shouldClickCollapseThread(e))return this.setState({isExpanded:!1})}else if(this._shouldClickExpandThread(e))return this.setState({isExpanded:!0}),this.props.actionCreators.markConversationSeen(this.props.commentActivity.activity_key)},_shouldClickExpandThread:function(e){var o;return o=t(e.target),0===o.parents(".threaded-comment-header").length},_shouldClickCollapseThread:function(e){var o;return o=t(e.target),0!==o.closest(".threaded-comment-header").length&&0===o.closest(".annotation-thumbnail-page").length&&0===o.closest(".annotation-thumbnail-label-text").length},hasReplies:function(){return this.repliesCount()>0},repliesCount:function(){return this.props.commentActivity.comment_activities.length},onUpdateResolve:function(t){return this.props.actionCreators.setCommentResolved({commentActivityKey:this.props.commentActivity.activity_key,resolved:t})},renderHeader:function(){var t;if(v.MAESTRO_ENABLED&&this.state.isExpanded)return t=this.props.commentActivity.comment,A.div({className:"threaded-comment-list__header"},A.div({className:"clearfix"},I({resolved:t.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline})))},renderCommentActivityUI:function(t,e,o,n){return null==o&&(o=!1),null==n&&(n=!1),T({key:"comment_"+e.activity_key,ref:"child-"+e.activity_key,parentActivity:t,fileActivity:this.props.activity,comment_activity:e,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,annotationNumber:this.props.annotationNumber,shouldShowReplyButton:n,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldAutoLinkify:this.props.shouldAutoLinkify,isReply:o,isExpanded:this.state.isExpanded,truncateLength:100,isInAnnotationBubble:this.props.isInAnnotationBubble,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode,scrollIntoView:this.props.scrollIntoView})},render:function(){var t,o,n,s,i,r,a,l;if(o=[],this.hasReplies())for(a=this.props.commentActivity.comment_activities,s=n=0,r=a.length;n<r;s=++n)t=a[s],t.comment.resolved&&!this.props.showResolvedComments||(i=s===this.repliesCount()-1,o.push(this.renderCommentActivityUI(this.props.commentActivity,t,!0,i)));return A.div({className:e({"threaded-comment-list":!0,"threaded-comment-list--expanded":this.state.isExpanded,"threaded-comment-list--unread":this.props.commentActivity.shouldHighlightAsUnread(),"threaded-comment-list--highlighting":this.state.highlighting}),"data-comment-activity-key":this.props.commentActivity.activity_key,onClick:this.onClick,onMouseLeave:this._onMouseLeave},this.renderHeader(),A.div({},this.renderCommentActivityUI(this.props.activity,this.props.commentActivity,!1,!(this.hasReplies()||this.props.commentActivity.is_pending)),this.hasReplies()?this.repliesCount()>1&&!this.state.isExpanded?[A.div({className:"comment-activity__expand"},A.a({className:"replies-count-button"},x("%(num)s more reply","%(num)s more replies",this.repliesCount()-1).format({num:this.repliesCount()-1}))),o[o.length-1]]:o:void 0),this.state.isExpanded&&!this.props.commentActivity.is_pending?(l=!0,v.MAESTRO_ENABLED&&(l=this.state.isExpandedByReply),S({ref:"commentInput",activity:this.props.activity,user:this.props.user,usersToNotify:this.props.commentActivity.users_to_notify,onAddComment:this.onAddComment,onCancelComment:this.props.onCancelComment,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,resizeCallback:this.resizeCallback,popupsShouldDropdown:this.state.popupsShouldDropdown,onFocus:this.props.onReplyInputFocus,onBlur:this.props.onReplyInputBlur,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,onChange:this.props.onInputChange,shouldShowPostText:this.props.shouldShowPostText,initialText:this.props.replyText,commentMetadataAllowed:y.ALLOW_STICKERS,shouldEnableStickers:y.ALLOW_STICKERS,shouldInitiallyFocusInput:l,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isReplyInput:!0,shouldShowAvatar:!0,shouldAlwaysInEditMode:!0,onMentionedUsersChanged:this.props.onMentionedUsersChanged,isCommentsServerView:this.props.isCommentsServerView,actionCreators:this.props.actionCreators,isDemoMode:this.props.isDemoMode})):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_header",["external/classnames","external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/react/activity/resolve_button","modules/clean/react/activity/annotation_button","modules/constants/comments_panel","modules/core/i18n"],function(t,e,o,n,s,i,r,a,l,c){var u,p,d,h,m,_;return i.Annotation,d=i.AnnotationTypes,i.AnnotationSubtypes,p=a.AnnotationThumbnailClass,m=c._,h=e.createFactory(r),u=e.createFactory(p),_=e.DOM,e.createClass({displayName:"ThreadedCommentHeader",mixins:[e.addons.PureRenderMixin],propTypes:{annotation:e.PropTypes.object,revision:e.PropTypes.object,isOldRevision:e.PropTypes.bool,onClick:e.PropTypes.func,isHeader:e.PropTypes.bool,onUpdateResolve:e.PropTypes.func,isOffline:e.PropTypes.bool,shouldShowResolveButton:e.PropTypes.bool,resolved:e.PropTypes.bool,annotationNumber:e.PropTypes.number,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,showAnnotationThumbnail:e.PropTypes.bool},_getPrimaryText:function(t){return m(this.props.shouldAnnotationButtonUseThumbnailUrls?t.type===d.HIGHLIGHT?this.props.showAnnotationThumbnail?"Close text annotation":"View text annotation":this.props.showAnnotationThumbnail?"Close thumbnail":"View thumbnail":"View on file")},_renderAnnotationNumber:function(){var e;return e={"annotation-number":!0,"annotation-number--resolved":this.props.resolved,"annotation-number--old-revision":this.props.isOldRevision},_.div({className:t(e)},this.props.annotationNumber)},_renderAnnotationThumbnail:function(){return u({annotation:this.props.annotation,thumbnailUrl:this.props.annotation.thumbnail_url})},render:function(){var e;return e={"annotation-thumbnail-label":!0,"is-on-old-revision":this.props.isOldRevision},_.div({},_.div({className:"threaded-comment-header comment-annotation",onClick:this.props.onClick},_.div({className:"comment-annotation-button"},this._renderAnnotationNumber(),_.div({className:t(e)},_.a({className:"annotation-thumbnail-label-text"},this._getPrimaryText(this.props.annotation)),this.props.isOldRevision?_.div({className:"older-revision"},m("Older version")):void 0),this.props.shouldShowResolveButton?h({resolved:this.props.resolved,onUpdateResolve:this.props.onUpdateResolve,isOffline:this.props.isOffline}):void 0)),this.props.showAnnotationThumbnail?this.props.annotation.type===d.HIGHLIGHT?_.div({className:"comment-annotation-highlight"},this.props.annotation.text_highlight.text):_.div({className:"comment-annotation-thumbnail"},this._renderAnnotationThumbnail()):void 0)}})})}.call(this),define("modules/clean/react/file_comments/toggle_bar",["require","exports","tslib","external/classnames","external/react","modules/clean/react/file_sidebar/file_sidebar_maestro_toggle_button","modules/clean/react/file_viewer/actions","modules/clean/react/file_viewer/constants","modules/core/i18n","modules/clean/comments/store"],function(t,e,o,n,s,i,r,a,l,c){"use strict";var u=(function(t){function e(e){var o=t.call(this,e)||this;return o.onStoreUpdate=function(){o.setState(o.getStateFromStore())},o.showComments=function(){o.props.actionCreators.showComments(),r.logUserAction(a.UserActionNames.TOGGLE_COMMENTS_ON,a.UserActionContextNames.SIDEBAR)},o.hideComments=function(){o.props.actionCreators.hideComments(),r.logUserAction(a.UserActionNames.TOGGLE_COMMENTS_OFF,a.UserActionContextNames.SIDEBAR)},o.getCommentsText=function(){return o.state.unreadCommentCount>0?l._("Comments (%(unread_comment_count)s)").format({unread_comment_count:o.state.unreadCommentCount}):l._("Comments")},o._renderCommentsText=function(){return o.props.isHidden?null:s.createElement("div",{className:"file-sidebar__unread-count"},o.getCommentsText())},o.state=o.getStateFromStore(),o.removeStoreListener=c.listen(o.onStoreUpdate),o}return o.__extends(e,t),e.prototype.componentWillUnmount=function(){this.removeStoreListener&&this.removeStoreListener()},e.prototype.getStateFromStore=function(){return{unreadCommentCount:c.unreadCommentCount()}},e.prototype.render=function(){var t,e;this.props.isHidden?(t=l._("Show Sidebar"),e=this.showComments):(t=l._("Hide Sidebar"),e=this.hideComments);var o=n({"toggle-comments__button":!0,"toggle-comments__button-on":!this.props.isHidden,"toggle-comments__button-off":this.props.isHidden});return s.createElement("div",{className:"file-sidebar__toggle-bar clearfix"},this._renderCommentsText(),s.createElement(i.FileSidebarMaestroToggleButton,{className:o,isOpen:!this.props.isHidden,alt:t,onClick:e}))},e})(s.Component);e.FileCommentsToggleBar=u}),define("modules/clean/react/file_sidebar/file_sidebar_maestro_toggle_button",["require","exports","tslib","external/react","modules/clean/react/sprite","modules/clean/react/title_bubble","modules/core/i18n"],function(t,e,o,n,s,i,r){"use strict";var a=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o.__extends(e,t),e.prototype.render=function(){var t=this.props.isOpen?r._("Hide"):r._("Show"),e=this.props.isOpen?"s_sidebar_hide":"s_sidebar_show",o="sprite-button "+this.props.className;return n.createElement(i,{content:t,position:i.POSITIONS.LEFT,distanceFromTarget:10},n.createElement("button",{onClick:this.props.onClick,disabled:this.props.isDisabled,className:o},n.createElement(s,{group:"web",name:e,alt:this.props.alt})))},e})(n.Component);a.defaultProps={className:""},e.FileSidebarMaestroToggleButton=a}),define("modules/clean/react/pure_render",["require","exports","external/react"],function(t,e,o){"use strict";function n(t){t.prototype.shouldComponentUpdate=s.shouldComponentUpdate}var s=o.addons.PureRenderMixin;e.pureRender=n}),function(){define("modules/clean/sticker_util",["external/underscore","modules/constants/stickers"],function(t,e){return new((function(){function o(){}return o.prototype.isLiveSticker=function(o){var n;return this.stickerById||(this.stickerById=t.indexBy(e.stickers,"id")),(null!=(n=this.stickerById[o])?n.live_sticker:void 0)===!0},o.prototype.getStickerImageUrl=function(t,o){return null==o&&(o="png"),e.sticker_img_url+"/"+t+"?type="+o},o.prototype.getStickerSetImageUrl=function(t){return e.sticker_set_img_url+"/"+t},o.prototype.getStickers=function(){var t,o,n,s,i,r,a,l,c,u,p;if(!this.stickers){for(this.stickers=e.sets,a=this.stickers,t=0,s=a.length;t<s;t++)u=a[t],u.stickers=[];for(l=e.stickers,o=0,i=l.length;o<i;o++)for(p=l[o],c=this.stickers,n=0,r=c.length;n<r;n++)if(u=c[n],p.set_id===u.id){u.stickers.push(p);break}}return this.stickers},o})())})}.call(this);
//# sourceMappingURL=pkg-maestro-ac.min.js-vflwT61GM.map